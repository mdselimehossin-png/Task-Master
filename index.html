<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Take Master - Earn Money Online</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#4a90e2;
  --secondary:#50e3c2;
  --accent:#f5a623;
  --green:#2ecc71;
  --red:#e74c3c;
  --gold:#ffd700;
  --background:#0f0f1e;
  --card:#1a1a2e;
  --card-light:#252541;
  --text-primary:#ffffff;
  --text-secondary:#b8b8d4;
  --shadow:0 4px 12px rgba(0,0,0,0.3);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  margin:0;
  font-family:'Roboto',sans-serif;
  background:linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
  background-size:400% 400%;
  animation:gradientShift 15s ease infinite;
  color:var(--text-primary);
}
@keyframes gradientShift{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes bounceIn {
  0% { transform: scale(0.3); opacity: 0; }
  50% { transform: scale(1.05); }
  70% { transform: scale(0.9); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

/* Faster spinning animation */
@keyframes reelSpinFast {
  0% { transform: translateY(0) rotate(0deg); }
  25% { transform: translateY(-15px) rotate(90deg); }
  50% { transform: translateY(-20px) rotate(180deg); }
  75% { transform: translateY(-15px) rotate(270deg); }
  100% { transform: translateY(0) rotate(360deg); }
}

.container{
  max-width:450px;
  margin:20px auto;
  background:var(--card);
  border-radius:15px;
  box-shadow:var(--shadow);
  overflow:hidden;
  min-height:90vh;
  padding-bottom:50px;
  border:1px solid rgba(255,255,255,0.1);
}

.header-title-area {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  justify-content: center;
}
.header-title {
  font-weight: 700;
  color: #fff;
  font-size: 18px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.header-telegram-btn {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  text-decoration: none;
  color: #000;
  background: linear-gradient(135deg,#ffd700,#ffa500);
  box-shadow: 0 2px 8px rgba(255,215,0,0.3);
  transition: transform .2s, box-shadow .2s;
}
.header-telegram-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255,215,0,0.5);
}

.main-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:15px;
  position:sticky;
  top:0;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  z-index:10;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
}
.menu-btn{
  background:rgba(255,255,255,0.2);
  color:#fff;
  font-size:20px;
  border:none;
  padding:10px 14px;
  border-radius:8px;
  cursor:pointer;
  transition:0.3s;
}
.menu-btn:hover{background:rgba(255,255,255,0.3);}
.notification-icon{
  font-size:24px;
  cursor:pointer;
  position:relative;
  color:#fff;
}
.notification-count{
  position:absolute;
  top:-5px;
  right:-10px;
  background:var(--red);
  color:#fff;
  border-radius:50%;
  font-size:11px;
  padding:3px 7px;
  min-width:20px;
  text-align:center;
}
.menu-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:50;}
.side-menu{
  position:fixed;
  top:0;
  left:0;
  height:100vh;
  width:260px;
  background:var(--card);
  box-shadow:3px 0 20px rgba(0,0,0,0.5);
  transform:translateX(-100%);
  transition:transform 0.3s ease;
  z-index:60;
  overflow-y:auto;
  border-right:1px solid rgba(255,255,255,0.1);
}
.side-menu.open{transform:translateX(0);}
.drawer-header{
  padding:20px;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.drawer-title{font-weight:700;color:#fff;font-size:18px;}
.drawer-close{
  background:rgba(255,255,255,0.2);
  border:none;
  padding:8px 12px;
  border-radius:50%;
  cursor:pointer;
  font-size:18px;
  color:#fff;
}
.menu-list{list-style:none;padding:10px 0;margin:0;}
.menu-list li{
  padding:14px 20px;
  font-weight:500;
  border-bottom:1px solid rgba(255,255,255,0.05);
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:12px;
  transition:0.2s;
  color:var(--text-secondary);
}
.menu-list li:hover{background:rgba(102,126,234,0.2);color:var(--text-primary);}
.menu-list .active{background:rgba(102,126,234,0.3);color:var(--text-primary);font-weight:700;border-left:4px solid var(--primary);}

.profile-card{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  border-radius:20px;
  box-shadow:0 8px 20px rgba(102,126,234,0.4);
  padding:20px;
  margin:15px;
  position:relative;
  overflow:hidden;
}
.profile-content{
  position:relative;
  z-index:1;
  display:flex;
  align-items:center;
  gap:15px;
}
.profile-icon .avatar{
  width:80px;
  height:80px;
  border-radius:50%;
  background:linear-gradient(135deg,#ffd89b 0%,#19547b 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:45px;
  border:4px solid rgba(255,255,255,0.3);
  box-shadow:0 4px 15px rgba(0,0,0,0.2);
}
.profile-details{flex:1;}
.pname{
  color:#fff;
  font-weight:700;
  font-size:20px;
  text-shadow:0 2px 4px rgba(0,0,0,0.2);
  margin-bottom:5px;
}
.pphone,.pid{
  font-size:13px;
  color:rgba(255,255,255,0.9);
  margin:3px 0;
}
.pbalance{
  font-weight:700;
  color:#fff;
  margin-top:8px;
  font-size:16px;
  background:rgba(255,255,255,0.2);
  padding:8px 12px;
  border-radius:8px;
  display:inline-block;
}
.pbalance span{
  font-size:20px;
  color:#ffd700;
}
.notice-board{
  background:linear-gradient(135deg,rgba(255,193,7,0.2) 0%,rgba(255,152,0,0.2) 100%);
  color:#ffd54f;
  border:1px solid rgba(255,193,7,0.3);
  border-radius:12px;
  padding:12px 16px;
  margin:10px 15px;
  font-size:14px;
  border-left:5px solid var(--accent);
  line-height:1.6;
}
.notice-board strong{
  color:#ffc107;
  display:inline-block;
  margin-right:5px;
}

.daily-bonus-card{
  background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
  border-radius:15px;
  padding:20px;
  margin:15px;
  text-align:center;
  position:relative;
  overflow:hidden;
  box-shadow:0 8px 20px rgba(245,87,108,0.4);
}
.daily-bonus-card::before{
  content:'üéÅ';
  position:absolute;
  font-size:150px;
  opacity:0.1;
  top:-30px;
  right:-30px;
  animation:pulse 3s ease-in-out infinite;
}
.bonus-title{
  font-size:22px;
  font-weight:700;
  color:#fff;
  margin-bottom:10px;
  text-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.bonus-amount{
  font-size:36px;
  font-weight:700;
  color:#ffd700;
  margin:15px 0;
  text-shadow:0 2px 8px rgba(0,0,0,0.3);
}
.bonus-timer{
  font-size:14px;
  color:rgba(255,255,255,0.9);
  margin:10px 0;
  font-weight:600;
}
.bonus-streak{
  background:rgba(255,255,255,0.2);
  padding:8px 12px;
  border-radius:8px;
  margin-top:10px;
  font-size:13px;
  color:#fff;
}
.claim-bonus-btn{
  width:100%;
  padding:14px;
  background:linear-gradient(135deg,#ffd700 0%,#ffa500 100%);
  color:#000;
  border:none;
  border-radius:10px;
  font-weight:700;
  font-size:16px;
  cursor:pointer;
  margin-top:15px;
  transition:0.3s;
  box-shadow:0 4px 15px rgba(255,215,0,0.3);
}
.claim-bonus-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(255,215,0,0.5);
}
.claim-bonus-btn:disabled{
  background:#555;
  color:#999;
  cursor:not-allowed;
  opacity:0.6;
}

.refer-card{
  background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  border-radius:15px;
  padding:20px;
  margin:15px;
  position:relative;
  overflow:hidden;
  box-shadow:0 8px 20px rgba(79,172,254,0.4);
}
.refer-card::before{
  content:'üéØ';
  position:absolute;
  font-size:150px;
  opacity:0.1;
  bottom:-30px;
  left:-30px;
  animation:pulse 3s ease-in-out infinite;
}
.refer-title{
  font-size:20px;
  font-weight:700;
  color:#fff;
  margin-bottom:10px;
  text-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.refer-reward{
  background:rgba(255,255,255,0.2);
  padding:12px;
  border-radius:10px;
  margin:10px 0;
  color:#fff;
}
.refer-reward-amount{
  font-size:28px;
  font-weight:700;
  color:#ffd700;
  margin:5px 0;
}
.refer-code-box{
  background:rgba(255,255,255,0.9);
  padding:15px;
  border-radius:10px;
  margin:15px 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.refer-code{
  font-size:20px;
  font-weight:700;
  color:#333;
  letter-spacing:2px;
  flex:1;
  text-align:center;
}
.copy-btn{
  background:linear-gradient(135deg,var(--primary),#3a7bc8);
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  transition:0.3s;
  white-space:nowrap;
}
.copy-btn:hover{transform:scale(1.05);}
.refer-stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:15px;
}
.refer-stat-item{
  background:rgba(255,255,255,0.2);
  padding:12px;
  border-radius:8px;
  text-align:center;
  color:#fff;
}
.refer-stat-value{
  font-size:24px;
  font-weight:700;
  color:#ffd700;
}
.refer-stat-label{
  font-size:12px;
  margin-top:5px;
  opacity:0.9;
}

.task-board{
  background:linear-gradient(135deg,rgba(33,150,243,0.1) 0%,rgba(103,58,183,0.1) 100%);
  border-radius:15px;
  margin:15px;
  padding:15px;
  border-top:4px solid var(--primary);
  border:1px solid rgba(74,144,226,0.3);
}
.task-title{
  color:#64b5f6;
  font-weight:700;
  font-size:18px;
  margin-bottom:15px;
  display:flex;
  align-items:center;
  gap:8px;
}
.task-box{
  background:var(--card-light);
  border-radius:8px;
  box-shadow:0 1px 5px rgba(0,0,0,0.3);
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  transition:0.3s;
  border-left:3px solid transparent;
}
.task-box:hover{
  transform:translateY(-1px);
  box-shadow:0 2px 8px rgba(102,126,234,0.3);
  border-left-color:var(--primary);
}
.task-box.completed{
  background:rgba(46,204,113,0.1);
  border-left-color:var(--green);
  opacity:0.7;
}
.task-info{flex:1;}
.task-info strong{
  display:block;
  color:var(--text-primary);
  margin-bottom:3px;
  font-size:14px;
}
.task-reward{
  font-size:12px;
  color:var(--accent);
  font-weight:600;
}
.claim-btn{
  padding:8px 15px;
  font-size:13px;
  font-weight:700;
  border:none;
  border-radius:6px;
  cursor:pointer;
  transition:0.3s;
  white-space:nowrap;
  background:linear-gradient(135deg,var(--primary) 0%,#3a7bc8 100%);
  color:#fff;
}
.claim-btn:hover{transform:scale(1.05);}
.completed-badge{
  background:var(--green);
  color:#fff;
  padding:5px 12px;
  border-radius:5px;
  font-size:12px;
  font-weight:700;
}
.section{
  border-radius:15px;
  margin:15px;
  padding:20px;
  background:var(--card);
  box-shadow:var(--shadow);
  display:none;
  border:1px solid rgba(255,255,255,0.1);
}
.section.active{display:block;}
.section h2{
  font-size:22px;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin-bottom:20px;
}
.back-btn{
  background:linear-gradient(135deg,rgba(255,255,255,0.1) 0%,rgba(255,255,255,0.05) 100%);
  color:var(--text-primary);
  border:1px solid rgba(255,255,255,0.2);
  padding:10px 18px;
  border-radius:8px;
  margin:0 0 15px 0;
  cursor:pointer;
  transition:0.3s;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  gap:5px;
  border:none;
}
.back-btn:hover{
  background:linear-gradient(135deg,rgba(255,255,255,0.2) 0%,rgba(255,255,255,0.1) 100%);
  transform:translateX(-3px);
}

.refer-list{
  background:var(--card-light);
  border-radius:12px;
  padding:15px;
  margin-top:20px;
}
.refer-list-item{
  background:var(--card);
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-left:3px solid var(--secondary);
}
.refer-user-info{
  flex:1;
}
.refer-user-name{
  font-weight:700;
  color:var(--text-primary);
  font-size:15px;
}
.refer-user-date{
  font-size:12px;
  color:var(--text-secondary);
  margin-top:3px;
}
.refer-earned{
  background:linear-gradient(135deg,var(--green),#27ae60);
  color:#fff;
  padding:6px 12px;
  border-radius:6px;
  font-size:13px;
  font-weight:700;
}

.leaderboard-container{
  background:var(--card-light);
  border-radius:12px;
  padding:15px;
  margin-bottom:20px;
  border:1px solid rgba(255,255,255,0.1);
}
.leaderboard-item{
  background:var(--card);
  padding:15px;
  border-radius:10px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:15px;
  transition:0.3s;
  border-left:3px solid transparent;
}
.leaderboard-item:hover{
  transform:translateX(8px) scale(1.02);
  box-shadow:0 4px 20px rgba(102,126,234,0.3);
  border-left-color:var(--primary);
}
.leaderboard-item.top1{
  background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,193,7,0.2));
  border-left-color:#ffd700;
  position:relative;
  overflow:hidden;
}
.leaderboard-item.top1::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
  animation: shine 3s ease-in-out infinite;
}
.leaderboard-item.top2{
  background:linear-gradient(135deg,rgba(192,192,192,0.2),rgba(169,169,169,0.2));
  border-left-color:#c0c0c0;
}
.leaderboard-item.top3{
  background:linear-gradient(135deg,rgba(205,127,50,0.2),rgba(184,115,51,0.2));
  border-left-color:#cd7f32;
}
.leaderboard-item.current-user{
  background:linear-gradient(135deg,rgba(102,126,234,0.3),rgba(118,75,162,0.3));
  border-left-color:var(--primary);
  animation: pulse 2s ease-in-out infinite;
}
.rank-badge{
  width:50px;
  height:50px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:20px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  flex-shrink:0;
}
.rank-badge.gold{
  background:linear-gradient(135deg,#ffd700,#ffa500);
  color:#000;
}
.rank-badge.silver{
  background:linear-gradient(135deg,#c0c0c0,#a9a9a9);
  color:#000;
}
.rank-badge.bronze{
  background:linear-gradient(135deg,#cd7f32,#b8732b);
  color:#000;
}
.leaderboard-info{
  flex:1;
}
.leaderboard-name{
  font-weight:700;
  color:var(--text-primary);
  font-size:16px;
  margin-bottom:5px;
}
.leaderboard-earned{
  font-size:14px;
  color:var(--text-secondary);
}
.leaderboard-earned span{
  color:#ffd700;
  font-weight:700;
}
.profile-settings-card{
  background:var(--card-light);
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  border:1px solid rgba(255,255,255,0.1);
}
.profile-settings-card h3{
  color:var(--text-primary);
  margin-bottom:15px;
  font-size:18px;
}
.profile-info-row{
  display:flex;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid rgba(255,255,255,0.05);
}
.profile-info-label{
  color:var(--text-secondary);
  font-size:14px;
}
.profile-info-value{
  color:var(--text-primary);
  font-weight:600;
  font-size:14px;
}
.chat-container{
  background:var(--card-light);
  border-radius:12px;
  padding:15px;
  height:500px;
  display:flex;
  flex-direction:column;
  border:1px solid rgba(255,255,255,0.1);
}
.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  margin-bottom:15px;
  background:var(--card);
  border-radius:10px;
}
.chat-message{
  margin-bottom:15px;
  animation:slideIn 0.3s ease;
}
.chat-message.user{
  text-align:right;
}
.chat-message.admin{
  text-align:left;
}
.message-bubble{
  display:inline-block;
  max-width:80%;
  padding:12px 16px;
  border-radius:15px;
  word-wrap:break-word;
}
.chat-message.user .message-bubble{
  background:linear-gradient(135deg,var(--primary),#3a7bc8);
  color:#fff;
  border-bottom-right-radius:5px;
}
.chat-message.admin .message-bubble{
  background:var(--card-light);
  color:var(--text-primary);
  border-bottom-left-radius:5px;
  border:1px solid rgba(255,255,255,0.1);
}
.message-time{
  font-size:11px;
  color:var(--text-secondary);
  margin-top:5px;
}
.chat-input-container{
  display:flex;
  gap:10px;
}
.chat-input{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:2px solid rgba(255,255,255,0.1);
  background:var(--card);
  color:var(--text-primary);
  font-size:14px;
  outline:none;
  font-family:'Roboto',sans-serif;
}
.chat-input:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(74,144,226,0.2);
}
.chat-send-btn{
  padding:12px 20px;
  background:linear-gradient(135deg,var(--primary),#3a7bc8);
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  transition:0.3s;
}
.chat-send-btn:hover{
  transform:scale(1.05);
}
.form-group{
  margin-bottom:15px;
}
.form-group label{
  display:block;
  font-weight:600;
  margin-bottom:8px;
  color:var(--text-primary);
}
.form-group input,.form-group textarea{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:10px;
  border:2px solid rgba(255,255,255,0.1);
  background:var(--card-light);
  color:var(--text-primary);
  font-size:15px;
  outline:none;
  transition:0.3s;
  font-family:'Roboto',sans-serif;
}
.form-group input:focus,.form-group textarea:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(74,144,226,0.2);
  background:rgba(102,126,234,0.1);
}
.submit-btn{
  width:100%;
  padding:14px;
  background:linear-gradient(135deg,var(--primary) 0%,#3a7bc8 100%);
  color:#fff;
  border:none;
  border-radius:10px;
  font-weight:700;
  margin-top:10px;
  cursor:pointer;
  font-size:16px;
  transition:0.3s;
}
.submit-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 15px rgba(74,144,226,0.4);
}
.submit-btn:disabled{
  background:#555;
  cursor:not-allowed;
  opacity:0.6;
}
.auth-container{
  max-width:400px;
  margin:50px auto;
  background:var(--card);
  padding:30px;
  border-radius:20px;
  box-shadow:0 8px 30px rgba(0,0,0,0.5);
  border:1px solid rgba(255,255,255,0.1);
}
.auth-container h2{
  text-align:center;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin-bottom:20px;
  font-size:26px;
}
.app-logo{
  text-align:center;
  font-size:60px;
  margin-bottom:10px;
}
.signup-fields{display:none;}
.auth-container input{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:10px;
  border:2px solid rgba(255,255,255,0.1);
  background:var(--card-light);
  color:var(--text-primary);
  font-size:15px;
  outline:none;
  transition:0.3s;
}
.auth-container input::placeholder{
  color:rgba(184,184,212,0.5);
}
.auth-container input:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(74,144,226,0.2);
  background:rgba(102,126,234,0.1);
}
.auth-container button{
  width:100%;
  padding:14px;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  border:none;
  color:#fff;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  margin-top:10px;
  transition:0.3s;
  font-size:16px;
}
.auth-container button:hover{
  transform:translateY(-2px);
  box-shadow:0 4px 15px rgba(102,126,234,0.4);
}
.toggle-auth{
  text-align:center;
  font-size:14px;
  margin-top:15px;
  cursor:pointer;
  color:var(--secondary);
  font-weight:500;
}
.toggle-auth:hover{text-decoration:underline;}
.error-msg{
  color:#ff6b6b;
  font-size:13px;
  margin:8px 0;
  display:none;
  padding:10px;
  background:rgba(255,107,107,0.2);
  border-radius:6px;
  border-left:3px solid var(--red);
}
.success-msg{
  color:#51cf66;
  font-size:13px;
  margin:8px 0;
  display:none;
  padding:10px;
  background:rgba(81,207,102,0.2);
  border-radius:6px;
  border-left:3px solid var(--green);
}
.ad-popup-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.95);
  z-index:10000;
  display:flex;
  align-items:center;
  justify-content:center;
  animation:fadeIn 0.3s ease;
  padding:20px;
}
.ad-popup-content{
  background:var(--card);
  padding:25px;
  border-radius:20px;
  max-width:900px;
  width:100%;
  max-height:90vh;
  overflow-y:auto;
  text-align:center;
  border:1px solid rgba(255,255,255,0.1);
  box-shadow:0 10px 40px rgba(0,0,0,0.5);
  position:relative;
}
.ad-popup-title{
  font-size:22px;
  font-weight:700;
  color:var(--text-primary);
  margin-bottom:15px;
}
.ad-task-info{
  background:var(--card-light);
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
}
.ad-verification-status{
  background:rgba(255,255,255,0.1);
  padding:15px;
  border-radius:10px;
  margin:15px 0;
  border-left:4px solid var(--accent);
}
.verification-item{
  display:flex;
  align-items:center;
  gap:10px;
  margin:8px 0;
  font-size:14px;
}
.verification-icon{
  width:24px;
  height:24px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  flex-shrink:0;
}
.verification-icon.pending{
  background:rgba(255,193,7,0.2);
  color:var(--accent);
}
.verification-icon.success{
  background:rgba(46,204,113,0.2);
  color:var(--green);
}
.verification-icon.failed{
  background:rgba(231,76,60,0.2);
  color:var(--red);
}
.verification-text{
  flex:1;
  color:var(--text-secondary);
  text-align:left;
}
.verification-text.success{
  color:var(--green);
  font-weight:600;
}
.verification-text.failed{
  color:var(--red);
  font-weight:600;
}
.ad-container{
  width:100%;
  min-height:400px;
  background:var(--card-light);
  border-radius:10px;
  margin:20px 0;
  overflow:hidden;
  border:2px solid rgba(255,255,255,0.1);
}
.ad-container iframe{
  width:100%;
  height:400px;
  border:none;
  border-radius:10px;
}
.ad-timer-display{
  font-size:18px;
  font-weight:700;
  color:var(--primary);
  margin:20px 0;
  padding:15px;
  background:rgba(74,144,226,0.1);
  border-radius:10px;
  border:2px solid rgba(74,144,226,0.3);
}
.ad-close-btn{
  position:absolute;
  top:15px;
  right:15px;
  background:rgba(255,255,255,0.2);
  color:#fff;
  width:35px;
  height:35px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  font-size:20px;
  transition:0.3s;
  display:none;
  z-index:10;
}
.ad-close-btn:hover{
  background:var(--red);
  transform:rotate(90deg);
}
.success-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  z-index:10001;
  display:flex;
  align-items:center;
  justify-content:center;
  animation:fadeIn 0.3s ease;
}
.success-content{
  text-align:center;
  animation:bounceIn 0.5s ease;
}
.success-icon{
  font-size:100px;
  margin-bottom:20px;
}
.success-title{
  font-size:32px;
  font-weight:700;
  color:#fff;
  margin-bottom:10px;
}
.success-amount{
  font-size:24px;
  color:var(--accent);
  font-weight:700;
}
.wallet-cards{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:15px;
  margin-bottom:25px;
}
.wallet-card{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  padding:20px;
  border-radius:12px;
  color:#fff;
  text-align:center;
}
.wallet-card.green{
  background:linear-gradient(135deg,var(--green) 0%,#27ae60 100%);
}
.wallet-card.gold{
  background:linear-gradient(135deg,var(--accent) 0%,#f76b1c 100%);
}
.wallet-card.purple{
  background:linear-gradient(135deg,#9b59b6 0%,#8e44ad 100%);
}
.wallet-card .icon{
  font-size:32px;
  margin-bottom:10px;
}
.wallet-card .amount{
  font-size:28px;
  font-weight:700;
  margin-bottom:5px;
}
.wallet-card .label{
  font-size:12px;
  opacity:0.9;
}
.balance-display{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:#fff;
  padding:20px;
  border-radius:12px;
  text-align:center;
  margin-bottom:20px;
}
.balance-display .label{
  font-size:14px;
  opacity:0.9;
  margin-bottom:5px;
}
.balance-display .amount{
  font-size:36px;
  font-weight:700;
}
.withdraw-methods{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:20px;
}
.method-btn{
  padding:15px;
  border:2px solid rgba(255,255,255,0.2);
  border-radius:10px;
  background:var(--card-light);
  cursor:pointer;
  transition:0.3s;
  text-align:center;
  font-weight:600;
  color:var(--text-secondary);
}
.method-btn:hover{
  border-color:var(--primary);
  background:rgba(102,126,234,0.2);
  color:var(--text-primary);
}
.method-btn.active{
  border-color:var(--primary);
  background:rgba(102,126,234,0.2);
  color:#64b5f6;
}
.notification-item{
  background:var(--card-light);
  padding:15px;
  border-radius:10px;
  margin-bottom:10px;
  border-left:3px solid var(--primary);
  transition:0.3s;
}
.notification-item:hover{
  transform:translateX(5px);
}
.notification-item.unread{
  background:rgba(102,126,234,0.1);
  border-left-color:#ffd700;
}
.notification-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.notification-title{
  font-weight:700;
  color:var(--text-primary);
  font-size:15px;
}
.notification-date{
  font-size:11px;
  color:var(--text-secondary);
}
.notification-message{
  font-size:14px;
  color:var(--text-secondary);
  line-height:1.5;
}
.notification-badge{
  background:#ffd700;
  color:#000;
  padding:3px 8px;
  border-radius:10px;
  font-size:10px;
  font-weight:700;
  margin-left:8px;
}
.coin-conversion-display{
  margin-top:8px;
  padding:12px;
  background:rgba(255,193,7,0.1);
  border-radius:8px;
  border-left:3px solid var(--accent);
  display:none;
}
.coin-conversion-display .label{
  color:var(--text-secondary);
  font-size:13px;
}
.coin-conversion-display .value{
  color:var(--accent);
  font-weight:700;
  font-size:15px;
  margin-left:5px;
}

/* ===========================
   SLOT MACHINE CSS
   =========================== */
.slot-card{
  background:linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 50%, #16213e 100%);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.4);
  padding:20px;
  margin:15px;
  color:#fff;
}
.slot-title{font-size:20px;font-weight:700;margin-bottom:10px;}
.slot-meta{
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  background:rgba(255,255,255,0.05);
  border-radius:10px;padding:10px 12px;margin-bottom:12px;
  border:1px solid rgba(255,255,255,0.08);
}
.slot-badge{font-weight:700;padding:6px 10px;border-radius:8px;}
.slot-badge.ok{background:rgba(46,204,113,0.2);color:#2ecc71;border:1px solid rgba(46,204,113,0.5);}
.slot-badge.no{background:rgba(231,76,60,0.2);color:#e74c3c;border:1px solid rgba(231,76,60,0.5);}
.slot-board{
  background:var(--card-light);
  border-radius:12px;
  padding:15px;
  border:1px solid rgba(255,255,255,0.08);
  margin-bottom:12px;
}
.slot-balance{font-size:16px;font-weight:600;margin-bottom:6px;}
.slot-msg{font-size:13px;color:var(--text-secondary);}
.reel-area{
  display:flex;justify-content:center;align-items:center;gap:12px;
  background:linear-gradient(135deg,#222,#333);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.1);
  padding:20px;margin:10px 0 14px 0;
}
.reel{
  width:90px;height:90px;border-radius:12px;background:rgba(0,0,0,0.4);
  display:flex;align-items:center;justify-content:center;font-size:52px;
  border:2px solid rgba(255,255,255,0.15);
  transition:transform 0.1s ease;
  box-shadow:inset 0 4px 12px rgba(0,0,0,0.5);
}
.reel.spinning{
  animation:reelSpinFast 0.3s linear infinite;
}
.slot-ctrls{
  display:flex;flex-direction:column;gap:10px;
}
.spin-btn{
  padding:14px;
  background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
  color:#fff;border:none;border-radius:10px;font-weight:800;font-size:16px;cursor:pointer;
  box-shadow:0 8px 20px rgba(245,87,108,0.4);
}
.spin-btn:disabled{background:#555;color:#aaa;cursor:not-allowed;opacity:0.7;box-shadow:none}
.slot-info{
  display:grid;grid-template-columns:1fr 1fr;gap:10px;
}
.slot-info .card{
  background:var(--card-light);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.1);
}
.slot-info .label{font-size:12px;color:var(--text-secondary)}
.slot-info .value{font-size:18px;font-weight:700;margin-top:6px;color:#fff}

.deposit-box{
  background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
  border-radius:12px;padding:14px;margin-top:10px;
  border:1px solid rgba(255,255,255,0.15);
}
.deposit-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;}
.deposit-virtual{
  background:#fff;color:#000;border-radius:8px;padding:8px 10px;font-weight:800;display:inline-block;
  letter-spacing:1px;
}
.dep-actions{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;}
.btn-outline{
  background:transparent;border:1px solid #fff;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700;
}
.btn-outline:hover{background:rgba(255,255,255,0.1)}
.btn-primary{
  background:linear-gradient(135deg,var(--primary),#3a7bc8);
  color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:700;
}
.btn-primary:hover{transform:scale(1.05)}
.small{
  font-size:12px;opacity:0.9
}

.slot-history{
  background:var(--card-light);border-radius:12px;padding:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.08);
}
.hist-item{display:flex;justify-content:space-between;gap:10px;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.06)}
.hist-item:last-child{border-bottom:none}
.hist-left{display:flex;gap:8px;align-items:center}
.hist-badge{
  width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,0.1);font-weight:800
}
.hist-win{color:#2ecc71}
.hist-lose{color:#e74c3c}
.hist-time{font-size:12px;color:var(--text-secondary)}

/* Game Wallet Withdraw Styles */
.game-wallet-section{
  background:linear-gradient(135deg,rgba(155,89,182,0.1) 0%,rgba(142,68,173,0.1) 100%);
  border:1px solid rgba(155,89,182,0.3);
  border-radius:15px;
  padding:20px;
  margin:15px 0;
  position:relative;
  overflow:hidden;
}
.game-wallet-section::before{
  content:'üé∞';
  position:absolute;
  font-size:120px;
  opacity:0.1;
  top:-30px;
  right:-30px;
  animation:pulse 3s ease-in-out infinite;
}
.game-wallet-title{
  font-size:20px;
  font-weight:700;
  color:#9b59b6;
  margin-bottom:15px;
  text-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.game-wallet-balance{
  background:linear-gradient(135deg,#9b59b6 0%,#8e44ad 100%);
  color:#fff;
  padding:15px;
  border-radius:10px;
  text-align:center;
  margin-bottom:15px;
}
.game-wallet-balance .amount{
  font-size:32px;
  font-weight:700;
}
.game-wallet-actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:15px;
}
.game-wallet-btn{
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  transition:0.3s;
  color:#fff;
}
.game-wallet-btn.deposit{
  background:linear-gradient(135deg,#3498db 0%,#2980b9 100%);
}
.game-wallet-btn.withdraw{
  background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);
}
.game-wallet-btn:hover{
  transform:translateY(-2px);
}
.game-wallet-btn:disabled{
  background:#555;
  cursor:not-allowed;
  transform:none;
  opacity:0.6;
}

/* Transfer Options */
.transfer-options{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin:15px 0;
}
.transfer-option{
  padding:15px;
  border:2px solid rgba(255,255,255,0.2);
  border-radius:10px;
  background:var(--card-light);
  cursor:pointer;
  text-align:center;
  transition:0.3s;
}
.transfer-option:hover{
  border-color:var(--primary);
  background:rgba(102,126,234,0.2);
}
.transfer-option.active{
  border-color:var(--primary);
  background:rgba(102,126,234,0.2);
  color:#64b5f6;
}
.transfer-amount{
  font-size:24px;
  font-weight:700;
  margin:10px 0;
  color:#9b59b6;
}

/* Trading Styles */
.trading-card{
  background:var(--card);
  border-radius:15px;
  padding:20px;
  margin:15px;
  border:1px solid rgba(255,255,255,0.1);
}
.trading-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}
.trading-price{
  font-size:28px;
  font-weight:700;
  color:#ffd700;
  text-shadow:0 2px 4px rgba(0,0,0,0.3);
}
.trading-change{
  font-size:18px;
  font-weight:700;
  padding:8px 12px;
  border-radius:8px;
}
.trading-change.up{
  background:rgba(46,204,113,0.2);
  color:#2ecc71;
  border:1px solid rgba(46,204,113,0.5);
}
.trading-change.down{
  background:rgba(231,76,60,0.2);
  color:#e74c3c;
  border:1px solid rgba(231,76,60,0.5);
}
.trading-chart{
  height:240px; /* Fixed height for trading chart */
  margin:15px 0;
  border-radius:12px;
  background:var(--card-light);
  padding:10px;
}

@media (max-width: 768px) {
  .wallet-cards {
    grid-template-columns: 1fr;
  }
  .withdraw-methods {
    grid-template-columns: 1fr;
  }
  .ad-popup-content {
    padding: 20px;
    max-width: 95%;
  }
  .ad-container iframe {
    height: 300px;
  }
  .rank-badge {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  .chat-container {
    height: 400px;
  }
  .refer-stats {
    grid-template-columns: 1fr;
  }
  .game-wallet-actions,
  .transfer-options {
    grid-template-columns: 1fr;
  }
  .trading-chart {
    height: 200px;
  }
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

<div id="auth-section" class="auth-container">
  <div class="app-logo">üìã</div>
  <h2 id="auth-title">Take Master</h2>
  
  <div class="signup-fields" id="signup-fields">
    <input type="text" id="signup-name" placeholder="Full Name">
    <input type="text" id="signup-phone" placeholder="Phone Number (01XXXXXXXXX)">
    <input type="text" id="signup-refer" placeholder="Referral Code (Optional)">
  </div>
  
  <input type="email" id="auth-email" placeholder="Email Address">
  <input type="password" id="auth-password" placeholder="Password (min 6 characters)">
  
  <span class="error-msg" id="auth-error"></span>
  
  <button id="auth-btn" onclick="handleAuth()">Login</button>
  
  <div class="toggle-auth" id="toggle-auth" onclick="toggleAuthMode()">
    Don't have an account? Sign Up
  </div>
</div>

<div id="dashboard" class="container" style="display:none;">
  <div class="main-header">
    <button class="menu-btn" onclick="openMenu()">‚ò∞</button>
    <div class="header-title-area">
      <div class="header-title">Take Master</div>
      <a id="telegram-header-btn" class="header-telegram-btn" href="#" target="_blank" rel="noopener">Join Telegram</a>
    </div>
    <div class="notification-icon" onclick="showSection('notifications-section')">üîî
      <span class="notification-count" id="notification-count" style="display:none;">0</span>
    </div>
  </div>

  <div class="profile-card">
    <div class="profile-content">
      <div class="profile-icon">
        <div class="avatar">üë§</div>
      </div>
      <div class="profile-details">
        <div class="pname" id="user-name">User Name</div>
        <div class="pphone" id="user-phone">üì± 0000000000</div>
        <div class="pid" id="user-uid">üÜî TM000000</div>
        <div class="pbalance">üí∞ Balance: <span id="user-balance">0</span> coins</div>
      </div>
    </div>
  </div>

  <div id="dashboard-content">
    <div class="notice-board">
      <strong>üì¢ Notice:</strong>
      <span id="notice-text">Welcome to Take Master Dashboard!</span>
    </div>

    <div class="daily-bonus-card" id="daily-bonus-card">
      <div class="bonus-title">üéÅ Daily Bonus</div>
      <div class="bonus-amount" id="bonus-amount">+0</div>
      <div class="bonus-timer" id="bonus-timer">Available Now!</div>
      <div class="bonus-streak" id="bonus-streak">üî• Streak: 0 days</div>
      <button class="claim-bonus-btn" id="claim-bonus-btn" onclick="claimDailyBonus()">
        Claim Now
      </button>
    </div>

    <div class="refer-card">
      <div class="refer-title">üéØ Invite Friends & Earn</div>
      <div class="refer-reward">
        <div style="font-size:14px;">You & Your Friend Get</div>
        <div class="refer-reward-amount" id="refer-reward-display">+0</div>
        <div style="font-size:13px;opacity:0.9;">coins each</div>
      </div>
      
      <div class="refer-code-box">
        <div class="refer-code" id="my-refer-code">LOADING...</div>
        <button class="copy-btn" onclick="copyReferCode()">üìã Copy</button>
      </div>
      
      <button class="copy-btn" onclick="shareReferLink()" style="width:100%;margin-top:10px;background:linear-gradient(135deg,var(--green),#27ae60);">
        üì§ Share Link
      </button>
      
      <div class="refer-stats">
        <div class="refer-stat-item">
          <div class="refer-stat-value" id="total-refers">0</div>
          <div class="refer-stat-label">Total Refers</div>
        </div>
        <div class="refer-stat-item">
          <div class="refer-stat-value" id="refer-earnings">0</div>
          <div class="refer-stat-label">Total Earned</div>
        </div>
      </div>
    </div>

    <div class="task-board">
      <div class="task-title">üìã Available Tasks</div>
      <div id="tasks-list">Loading...</div>
    </div>
  </div>

  <div id="refer-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üéØ Referral System</h2>
    
    <div class="profile-settings-card">
      <h3>üìä Your Referral Stats</h3>
      <div class="profile-info-row">
        <div class="profile-info-label">Your Refer Code</div>
        <div class="profile-info-value" id="refer-page-code" style="color:var(--accent);">LOADING...</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Total Referrals</div>
        <div class="profile-info-value" id="refer-page-total">0</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Total Earned from Refers</div>
        <div class="profile-info-value" id="refer-page-earned" style="color:var(--green);">0 coins</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Reward per Referral</div>
        <div class="profile-info-value" id="refer-page-reward" style="color:var(--accent);">0 coins</div>
      </div>
    </div>
    
    <h3 style="margin:20px 0 10px 0;color:var(--text-primary);">üë• Your Referrals</h3>
    <div class="refer-list" id="refer-list">
      <div style="text-align:center;padding:20px;color:var(--text-secondary);">No referrals yet</div>
    </div>
  </div>

  <div id="leaderboard-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üèÜ Leaderboard</h2>
    
    <div style="text-align:right;margin-bottom:15px;">
      <button onclick="loadLeaderboard()" style="padding:8px 16px;background:linear-gradient(135deg,var(--primary),#3a7bc8);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">
        üîÑ Refresh
      </button>
    </div>
    
    <div class="leaderboard-container" id="leaderboard-list">
      <div style="text-align:center;padding:20px;">Loading...</div>
    </div>
  </div>

  <div id="profile-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üë§ Profile Settings</h2>
    
    <div class="profile-settings-card">
      <h3>üìã Personal Information</h3>
      <div class="profile-info-row">
        <div class="profile-info-label">Full Name</div>
        <div class="profile-info-value" id="profile-name">Loading...</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Phone Number</div>
        <div class="profile-info-value" id="profile-phone">Loading...</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Email Address</div>
        <div class="profile-info-value" id="profile-email">Loading...</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">User ID</div>
        <div class="profile-info-value" id="profile-uid">Loading...</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Member Since</div>
        <div class="profile-info-value" id="profile-joined">Loading...</div>
      </div>
    </div>

    <div class="profile-settings-card">
      <h3>üí∞ Account Summary</h3>
      <div class="profile-info-row">
        <div class="profile-info-label">Current Balance</div>
        <div class="profile-info-value" id="profile-balance">0 coins</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Total Earned</div>
        <div class="profile-info-value" id="profile-earned">0 coins</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Total Withdrawn</div>
        <div class="profile-info-value" id="profile-withdrawn">0 coins</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-label">Total Ads Viewed</div>
        <div class="profile-info-value" id="profile-ads-viewed">0</div>
      </div>
    </div>
  </div>

  <div id="chat-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üí¨ Chat with Admin</h2>
    
    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <div style="text-align:center;padding:40px;color:var(--text-secondary);">
          <div style="font-size:48px;margin-bottom:10px;">üí¨</div>
          <div>No messages yet</div>
        </div>
      </div>
      
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chat-input" placeholder="Type your message..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="chat-send-btn" onclick="sendMessage()">üì§</button>
      </div>
    </div>
  </div>

  <div id="withdraw-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üí∏ Withdraw Balance</h2>
    
    <div class="balance-display">
      <div class="label">Available Balance</div>
      <div class="amount" id="withdraw-balance">0 coins (0 ‡ß≥)</div>
    </div>

    <!-- Game Wallet Withdraw Section -->
    <div class="game-wallet-section">
      <div class="game-wallet-title">üé∞ Game Wallet</div>
      <div class="game-wallet-balance">
        <div class="amount" id="game-wallet-balance">0 coins</div>
        <div class="small">Your game winnings</div>
      </div>
      <div class="game-wallet-actions">
        <button class="game-wallet-btn deposit" onclick="showGameWalletTransfer('toMain')">
          üí∞ Transfer to Main
        </button>
        <button class="game-wallet-btn withdraw" onclick="showGameWalletWithdraw()">
          üè¶ Withdraw Game Coins
        </button>
      </div>
    </div>
    
    <!-- Main Wallet Withdraw -->
    <div class="profile-settings-card">
      <h3>üí∞ Main Wallet Withdraw</h3>
      <div class="withdraw-methods">
        <div class="method-btn active" onclick="selectMethod('nagad')">üì± Nagad</div>
        <div class="method-btn" onclick="selectMethod('rocket')">üöÄ Rocket</div>
      </div>
      
      <div class="form-group">
        <label>Payment Method</label>
        <input type="text" id="withdraw-method" value="nagad" readonly>
      </div>
      
      <div class="form-group">
        <label>Account Number</label>
        <input type="text" id="withdraw-account" placeholder="01XXXXXXXXX">
      </div>
      
      <div class="form-group">
        <label>Amount in BDT (‡ß≥)</label>
        <input type="number" id="withdraw-amount" placeholder="Enter amount in Taka" oninput="showCoinConversion()">
        <div id="coin-conversion-display" class="coin-conversion-display">
          <span class="label">Required coins:</span>
          <span class="value" id="required-coins">0</span>
        </div>
      </div>
      
      <span class="error-msg" id="withdraw-error"></span>
      <span class="success-msg" id="withdraw-success"></span>
      
      <button class="submit-btn" id="withdraw-submit-btn" onclick="submitWithdraw()">üí∏ Request Withdraw</button>
    </div>
  </div>

  <div id="wallet-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üíº My Wallet</h2>
    
    <div class="wallet-cards">
      <div class="wallet-card">
        <div class="icon">üí∞</div>
        <div class="amount" id="wallet-current-balance">0</div>
        <div class="label">Main Balance</div>
      </div>
      
      <div class="wallet-card green">
        <div class="icon">üìà</div>
        <div class="amount" id="wallet-total-earned">0</div>
        <div class="label">Total Earned</div>
      </div>
      
      <div class="wallet-card gold">
        <div class="icon">üì§</div>
        <div class="amount" id="wallet-withdrawn">0</div>
        <div class="label">Total Withdrawn</div>
      </div>
      
      <div class="wallet-card purple">
        <div class="icon">üé∞</div>
        <div class="amount" id="wallet-game-balance">0</div>
        <div class="label">Game Wallet</div>
      </div>
    </div>

    <!-- Transfer Between Wallets -->
    <div class="profile-settings-card">
      <h3>‚ÜîÔ∏è Transfer Between Wallets</h3>
      
      <div class="transfer-options">
        <div class="transfer-option active" id="transfer-main-to-game" onclick="selectTransferOption('mainToGame')">
          <div>Main ‚ûú Game</div>
          <div class="transfer-amount" id="main-to-game-amount">0</div>
        </div>
        <div class="transfer-option" id="transfer-game-to-main" onclick="selectTransferOption('gameToMain')">
          <div>Game ‚ûú Main</div>
          <div class="transfer-amount" id="game-to-main-amount">0</div>
        </div>
      </div>

      <div class="form-group">
        <label>Transfer Amount (Coins)</label>
        <input type="number" id="transfer-amount" placeholder="Enter coins to transfer" min="1">
        <div id="transfer-info" class="coin-conversion-display">
          <span class="label">Info:</span>
          <span class="value" id="transfer-details">Select transfer option</span>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn-primary" style="flex:1; padding:12px;" onclick="executeTransfer()">
          üîÑ Transfer
        </button>
      </div>

      <div id="transfer-error" class="error-msg"></div>
      <div id="transfer-success" class="success-msg"></div>
    </div>
  </div>

  <div id="notifications-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üîî Notifications</h2>
    
    <div id="notifications-list">
      <div style="text-align:center;padding:20px;">No notifications</div>
    </div>
  </div>

  <!-- LIVE TRADING -->
  <div id="trading-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üìà Live Trading</h2>

    <div class="trading-card">
      <div class="trading-header">
        <div>
          <div style="font-size:14px;color:var(--text-secondary)">Like Coin Price (Coins per 1 Taka)</div>
          <div class="trading-price" id="trading-price">-</div>
        </div>
        <div class="trading-change up" id="trading-change">-</div>
      </div>
      <div class="trading-chart">
        <canvas id="priceChart"></canvas>
      </div>
      <!-- Removed trading action buttons as requested -->
    </div>
  </div>

  <!-- SLOT MACHINE SECTION -->
  <div id="slot-section" class="section">
    <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back</button>
    <h2>üé∞ Slot Machine</h2>

    <div class="slot-card">
      <div class="slot-title">üçÄ Weekly Spin (Friday Only)</div>
      <div class="slot-meta">
        <div>Status: <span id="slot-status-badge" class="slot-badge no">Checking...</span></div>
        <div>Spin Cost: <strong id="slot-spin-cost">-</strong> coins</div>
        <div>Next Round: <strong id="slot-next-round">-</strong></div>
        <div>Your Game Wallet: <strong id="slot-wallet-balance">0</strong> coins</div>
      </div>

      <div class="slot-board">
        <div class="slot-balance">Main Balance ‚Üí Game Wallet</div>
        <div style="display:flex;gap:10px;align-items:center;margin:10px 0;">
          <div style="flex:1;">
            <input type="number" id="deposit-amount" placeholder="Coins to deposit" min="1" style="width:100%;padding:10px;border-radius:8px;border:2px solid rgba(255,255,255,0.1);background:var(--card);color:var(--text-primary);">
          </div>
          <button class="btn-primary" onclick="depositToGameWallet()">üí∞ Deposit</button>
        </div>
        <div id="game-wallet-display" class="slot-msg">Loading...</div>
      </div>

      <div class="reel-area" id="reel-area">
        <div class="reel" id="reel-1">‚ùî</div>
        <div class="reel" id="reel-2">‚ùî</div>
        <div class="reel" id="reel-3">‚ùî</div>
      </div>

      <div class="slot-ctrls">
        <button class="spin-btn" id="spin-btn" disabled onclick="startSpin()">üîí Not Available</button>
        <div id="slot-msg" class="slot-msg"></div>
      </div>

      <div class="slot-info">
        <div class="card">
          <div class="label">Current Round</div>
          <div class="value" id="slot-round-id">-</div>
        </div>
        <div class="card">
          <div class="label">Last Result</div>
          <div class="value" id="slot-last-result">-</div>
        </div>
      </div>

      <div class="slot-history">
        <div style="font-weight:700;margin-bottom:6px;">üìú Spin History</div>
        <div id="slot-history-list">No spins yet</div>
      </div>
    </div>
  </div>

  <div class="menu-bg" onclick="closeMenu()"></div>
  <div class="side-menu" id="side-menu">
    <div class="drawer-header">
      <span class="drawer-title">Menu</span>
      <button class="drawer-close" onclick="closeMenu()">√ó</button>
    </div>
    <ul class="menu-list">
      <li class="active" onclick="showSection('dashboard')">üè† Dashboard</li>
      <li onclick="showSection('profile-section')">üë§ Profile</li>
      <li onclick="showSection('refer-section')">üéØ Referral</li>
      <li onclick="showSection('leaderboard-section')">üèÜ Leaderboard</li>
      <li onclick="showSection('trading-section')">üìà Live Trading</li>
      <li onclick="showSection('chat-section')">üí¨ Chat</li>
      <li onclick="showSection('withdraw-section')">üí∏ Withdraw</li>
      <li onclick="showSection('wallet-section')">üíº Wallet</li>
      <li onclick="showSection('notifications-section')">üîî Notifications</li>
      <li onclick="showSection('slot-section')">üé∞ Slot Machine</li>
      <li onclick="logout()">üö™ Logout</li>
    </ul>
  </div>
</div>

<script>
// =====================================================
// FIREBASE SETUP
// =====================================================
const firebaseConfig = {
  apiKey: "AIzaSyD6NfQHIlegwL2dU996GqqLT-BCk35U7Js",
  authDomain: "taskmaster-2c470.firebaseapp.com",
  databaseURL: "https://taskmaster-2c470-default-rtdb.firebaseio.com",
  projectId: "taskmaster-2c470",
  storageBucket: "taskmaster-2c470.firebasestorage.app",
  messagingSenderId: "975980927095",
  appId: "1:975980927095:web:d2c46612fa1f62e6c48e72"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// =====================================================
// GLOBAL VARS
// =====================================================
let currentUser = null;
let userBalance = 0;
let isSignupMode = false;
let completedTasks = {};
let userData = {};
let selectedWithdrawMethod = 'nagad';
let deviceFingerprint = null;
let userIP = null;
let dailyBonusSettings = {amount: 50, enabled: true};
let referSettings = {reward: 100, enabled: true};
let conversionRate = 100;   // coins per 1 BDT (default)
let minWithdrawBDT = 50;
let telegramChannelLink = 'https://t.me/your_channel';

// =====================================================
// SLOT MACHINE VARS
// =====================================================
const SLOT_SYMBOLS = ["üçí","üçã","üçä","üçá","üçâ","‚≠ê","7Ô∏è‚É£"];
let slotSettings = {
  enabledDays: [5],            // default Friday
  spinCost: 10,
  minDeposit: 50,
  virtualNumbers: { nagad: "01XXXXXXXXX", rocket: "01XXXXXXXXX" }
};
let currentSlotRound = null;
let slotWalletBalance = 0;
let lastSpinResult = null;
let isSpinning = false;
let userWinRate = 15; // Admin controlled win rate (0-100)

// =====================================================
// LIVE TRADING VARS
// =====================================================
let tradingChart = null;
let priceHistory = []; // {t: timestamp, v: price}

// =====================================================
// GAME WALLET VARS
// =====================================================
let gameWalletTransactions = [];
let currentTransferOption = 'mainToGame';

// =====================================================
// UTILS
// =====================================================
function loadConversionRate(){
  db.ref('settings/conversion').on('value', snapshot => {
    if(snapshot.exists()){
      const data = snapshot.val();
      conversionRate = data.coinsPerTaka || 100;
      minWithdrawBDT = data.minWithdrawBDT || 50;
      updateWithdrawDisplay();
    }
  });
}
function coinsToBDT(coins){
  return Math.floor(coins / conversionRate);
}
function bdtToCoins(bdt){
  return bdt * conversionRate;
}
function updateWithdrawDisplay(){
  const balanceInBDT = coinsToBDT(userBalance);
  document.getElementById('withdraw-balance').innerText = userBalance + ' coins (' + balanceInBDT + ' ‡ß≥)';
}
function showCoinConversion(){
  const bdtInput = document.getElementById('withdraw-amount').value;
  const display = document.getElementById('coin-conversion-display');
  const requiredCoinsElem = document.getElementById('required-coins');
  if(bdtInput && !isNaN(bdtInput) && parseInt(bdtInput) > 0){
    const bdt = parseInt(bdtInput);
    const requiredCoins = bdtToCoins(bdt);
    requiredCoinsElem.innerText = requiredCoins + ' coins';
    display.style.display = 'block';
  } else {
    display.style.display = 'none';
  }
}
async function getDeviceFingerprint(){
  try {
    const fpPromise = FingerprintJS.load();
    const fp = await Promise.race([fpPromise, new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 2000))]);
    const result = await fp.get();
    deviceFingerprint = result.visitorId;
    return deviceFingerprint;
  } catch(error) {
    deviceFingerprint = 'FP_' + Date.now();
    return deviceFingerprint;
  }
}
async function getUserIP(){
  try {
    const response = await Promise.race([fetch('https://api.ipify.org?format=json'), new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 2000))]);
    const data = await response.json();
    userIP = data.ip;
    return userIP;
  } catch(error) {
    userIP = 'IP_' + Date.now();
    return userIP;
  }
}
async function initializeDeviceDetection(){
  await Promise.all([getDeviceFingerprint(), getUserIP()]);
}
function startLiveActivityTracking(){
  if(!currentUser) return;
  const uid = currentUser.uid;
  const liveActivityRef = db.ref('liveActivity/' + uid);
  liveActivityRef.set({
    uid: uid,
    userName: userData.name || 'Unknown',
    userID: userData.userID || 'N/A',
    status: 'online',
    location: 'dashboard',
    lastActivity: firebase.database.ServerValue.TIMESTAMP,
    deviceInfo: {
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      screenResolution: `${screen.width}x${screen.height}`,
      ip: userIP,
      deviceId: deviceFingerprint
    },
    totalAdsViewed: userData.adsViewed || 0,
    tabSwitches: 0
  });
  setInterval(() => {
    if(currentUser){
      liveActivityRef.update({
        lastActivity: firebase.database.ServerValue.TIMESTAMP,
        status: document.hidden ? 'idle' : 'online'
      });
    }
  }, 10000);
  liveActivityRef.onDisconnect().remove();
}

// =====================================================
// TELEGRAM
// =====================================================
function loadTelegramChannel(){
  // Default fallback link (update-able from DB)
  telegramChannelLink = telegramChannelLink || 'https://t.me/your_channel';
  db.ref('settings/telegramChannel').on('value', snap=>{
    telegramChannelLink = snap.val() || telegramChannelLink;
    const btn = document.getElementById('telegram-header-btn');
    if(btn && telegramChannelLink){
      btn.href = telegramChannelLink;
    }
  });
}

// =====================================================
// DAILY BONUS
// =====================================================
function loadDailyBonusSettings(){
  db.ref('settings/dailyBonus').on('value', snapshot => {
    if(snapshot.exists()){
      dailyBonusSettings = snapshot.val();
    }
    updateDailyBonusUI();
  });
}
function updateDailyBonusUI(){
  if(!currentUser) return;
  const bonusAmount = dailyBonusSettings.amount || 50;
  const enabled = dailyBonusSettings.enabled !== false;
  document.getElementById('bonus-amount').innerText = '+' + bonusAmount;
  if(!enabled){
    document.getElementById('claim-bonus-btn').disabled = true;
    document.getElementById('claim-bonus-btn').innerText = 'Daily Bonus Disabled';
    document.getElementById('bonus-timer').innerText = 'Currently unavailable';
    return;
  }
  db.ref('users/' + currentUser.uid).once('value').then(snapshot => {
    const data = snapshot.val();
    const lastClaim = data.lastDailyBonus || 0;
    const streak = data.dailyStreak || 0;
    document.getElementById('bonus-streak').innerText = 'üî• Streak: ' + streak + ' days';
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    const timeSinceClaim = now - lastClaim;
    if(timeSinceClaim >= oneDayMs){
      document.getElementById('claim-bonus-btn').disabled = false;
      document.getElementById('claim-bonus-btn').innerText = 'üéÅ Claim ' + bonusAmount + ' Coins';
      document.getElementById('bonus-timer').innerText = 'Available Now!';
    } else {
      const remainingMs = oneDayMs - timeSinceClaim;
      document.getElementById('claim-bonus-btn').disabled = true;
      updateBonusTimer(remainingMs);
    }
  });
}
function updateBonusTimer(remainingMs){
  const hours = Math.floor(remainingMs / (1000 * 60 * 60));
  const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
  document.getElementById('bonus-timer').innerText = `Next in: ${hours}h ${minutes}m ${seconds}s`;
  document.getElementById('claim-bonus-btn').innerText = `‚è∞ Come back later`;
  if(remainingMs > 0){
    setTimeout(() => updateBonusTimer(remainingMs - 1000), 1000);
  } else {
    updateDailyBonusUI();
  }
}
function claimDailyBonus(){
  if(!currentUser) return;
  const uid = currentUser.uid;
  const bonusAmount = dailyBonusSettings.amount || 50;
  db.ref('users/' + uid).once('value').then(snapshot => {
    const data = snapshot.val();
    const lastClaim = data.lastDailyBonus || 0;
    const streak = data.dailyStreak || 0;
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    const twoDaysMs = 48 * 60 * 60 * 1000;
    const timeSinceClaim = now - lastClaim;
    if(timeSinceClaim < oneDayMs){
      alert('‚è∞ You can claim once per day!');
      return;
    }
    let newStreak = streak;
    if(timeSinceClaim < twoDaysMs){
      newStreak++;
    } else {
      newStreak = 1;
    }
    const newBalance = (data.balance || 0) + bonusAmount;
    const newTotalEarned = (data.totalEarned || 0) + bonusAmount;
    db.ref('users/' + uid).update({
      balance: newBalance,
      totalEarned: newTotalEarned,
      lastDailyBonus: now,
      dailyStreak: newStreak
    }).then(() => {
      showSuccessAnimation(bonusAmount);
      updateDailyBonusUI();
      db.ref('notifications/' + uid).push({
        title: 'üéÅ Daily Bonus Claimed',
        message: `You received ${bonusAmount} coins! Current streak: ${newStreak} days`,
        timestamp: Date.now(),
        date: new Date().toLocaleString(),
        read: false
      });
    });
  });
}

// =====================================================
// REFERRALS
// =====================================================
function loadReferSettings(){
  db.ref('settings/referral').on('value', snapshot => {
    if(snapshot.exists()){
      referSettings = snapshot.val();
    }
    updateReferUI();
  });
}
function updateReferUI(){
  const reward = referSettings.reward || 100;
  document.getElementById('refer-reward-display').innerText = '+' + reward;
  document.getElementById('refer-page-reward').innerText = reward + ' coins';
}
function loadMyReferCode(){
  if(!currentUser) return;
  db.ref('users/' + currentUser.uid + '/referCode').once('value').then(snapshot => {
    let referCode = snapshot.val();
    if(!referCode){
      referCode = generateReferCode();
      db.ref('users/' + currentUser.uid).update({referCode: referCode});
    }
    document.getElementById('my-refer-code').innerText = referCode;
    document.getElementById('refer-page-code').innerText = referCode;
  });
}
function generateReferCode(){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = 'TM';
  for(let i = 0; i < 6; i++){
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}
function loadReferStats(){
  if(!currentUser) return;
  db.ref('users/' + currentUser.uid).on('value', snapshot => {
    const data = snapshot.val();
    const totalRefers = data.totalReferrals || 0;
    const referEarnings = data.referralEarnings || 0;
    document.getElementById('total-refers').innerText = totalRefers;
    document.getElementById('refer-earnings').innerText = referEarnings;
    document.getElementById('refer-page-total').innerText = totalRefers;
    document.getElementById('refer-page-earned').innerText = referEarnings + ' coins';
  });
}
function loadReferralList(){
  if(!currentUser) return;
  db.ref('referrals/' + currentUser.uid).on('value', snapshot => {
    const container = document.getElementById('refer-list');
    container.innerHTML = '';
    if(!snapshot.exists()){
      container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">No referrals yet</div>';
      return;
    }
    const referrals = [];
    snapshot.forEach(child => {
      const refer = child.val();
      referrals.push(refer);
    });
    referrals.sort((a, b) => b.timestamp - a.timestamp);
    referrals.forEach(refer => {
      const div = document.createElement('div');
      div.className = 'refer-list-item';
      div.innerHTML = `
        <div class="refer-user-info">
          <div class="refer-user-name">${refer.userName || 'User'}</div>
          <div class="refer-user-date">${refer.date || ''}</div>
        </div>
        <div class="refer-earned">+${refer.reward} coins</div>
      `;
      container.appendChild(div);
    });
  });
}
function copyReferCode(){
  const code = document.getElementById('my-refer-code').innerText;
  if(navigator.clipboard){
    navigator.clipboard.writeText(code).then(() => {
      alert('‚úÖ Refer code copied: ' + code);
    });
  } else {
    const input = document.createElement('input');
    input.value = code;
    document.body.appendChild(input);
    input.select();
    document.execCommand('copy');
    document.body.removeChild(input);
    alert('‚úÖ Refer code copied: ' + code);
  }
}
function shareReferLink(){
  const code = document.getElementById('my-refer-code').innerText;
  const link = window.location.origin + window.location.pathname + '?ref=' + code;
  const text = `üéÅ Join Take Master and earn money online!\n\nUse my referral code: ${code}\n\nüîó ${link}`;
  if(navigator.share){
    navigator.share({
      title: 'Take Master Referral',
      text: text
    }).catch(() => {});
  } else {
    if(navigator.clipboard){
      navigator.clipboard.writeText(text).then(() => {
        alert('‚úÖ Referral link copied to clipboard!');
      });
    } else {
      alert('Referral Code: ' + code + '\nShare this with your friends!');
    }
  }
}
async function processReferral(referCode, newUserId){
  if(!referCode) return;
  const referCodeUpper = referCode.toUpperCase().trim();
  const usersSnapshot = await db.ref('users').orderByChild('referCode').equalTo(referCodeUpper).once('value');
  if(!usersSnapshot.exists()){
    console.log('Invalid refer code');
    return;
  }
  const referrerId = Object.keys(usersSnapshot.val())[0];
  if(referrerId === newUserId){
    console.log('Cannot refer yourself');
    return;
  }
  const reward = referSettings.reward || 100;
  const newUserSnapshot = await db.ref('users/' + newUserId).once('value');
  const newUserData = newUserSnapshot.val();
  await db.ref('users/' + referrerId).transaction(data => {
    if(data){
      data.balance = (data.balance || 0) + reward;
      data.totalEarned = (data.totalEarned || 0) + reward;
      data.totalReferrals = (data.totalReferrals || 0) + 1;
      data.referralEarnings = (data.referralEarnings || 0) + reward;
    }
    return data;
  });
  await db.ref('users/' + newUserId).update({
    balance: (newUserData.balance || 0) + reward,
    totalEarned: (newUserData.totalEarned || 0) + reward,
    referredBy: referrerId,
    referredByCode: referCodeUpper
  });
  await db.ref('referrals/' + referrerId).push({
    userId: newUserId,
    userName: newUserData.name || 'User',
    reward: reward,
    timestamp: Date.now(),
    date: new Date().toLocaleString()
  });
  await db.ref('notifications/' + referrerId).push({
    title: 'üéØ New Referral!',
    message: `${newUserData.name || 'Someone'} joined using your code! You earned ${reward} coins.`,
    timestamp: Date.now(),
    date: new Date().toLocaleString(),
    read: false
  });
  await db.ref('notifications/' + newUserId).push({
    title: 'üéÅ Welcome Bonus!',
    message: `You received ${reward} coins for joining with a referral code!`,
    timestamp: Date.now(),
    date: new Date().toLocaleString(),
    read: false
  });
  console.log('Referral processed successfully');
}

// =====================================================
// TASKS & AD POPUP
// =====================================================
function openTask(link, taskId){
  if(!currentUser) return;
  db.ref('tasks/' + taskId).once('value').then(taskSnap => {
    const task = taskSnap.val();
    if(!task) return;
    showAdPopup(task, taskId, link);
  });
}
function showAdPopup(task, taskId, link){
  const popup = document.createElement('div');
  popup.className = 'ad-popup-overlay';
  popup.id = 'ad-popup-' + taskId;
  popup.innerHTML = `
    <div class="ad-popup-content">
      <button class="ad-close-btn" onclick="closeAdPopup('${taskId}')">√ó</button>
      <div class="ad-popup-title">üì∫ Visit Website & Watch</div>
      <div class="ad-task-info">
        <div style="color:var(--text-secondary);font-size:14px;margin-bottom:10px;">
          Task: <strong style="color:var(--text-primary);">${task.name}</strong>
        </div>
        <div style="color:var(--accent);font-weight:700;font-size:16px;">
          üéÅ Reward: ${task.reward} coins
        </div>
      </div>
      <div class="ad-verification-status" id="verification-status-${taskId}">
        <div class="verification-item">
          <div class="verification-icon pending" id="verify-load-${taskId}">‚è≥</div>
          <div class="verification-text" id="verify-load-text-${taskId}">Loading website...</div>
        </div>
        <div class="verification-item">
          <div class="verification-icon pending" id="verify-interact-${taskId}">‚è≥</div>
          <div class="verification-text" id="verify-interact-text-${taskId}">Waiting for interaction...</div>
        </div>
        <div class="verification-item">
          <div class="verification-icon pending" id="verify-time-${taskId}">‚è≥</div>
          <div class="verification-text" id="verify-time-text-${taskId}">Time: <span id="time-remaining-${taskId}">15s</span></div>
        </div>
      </div>
      <div class="ad-container">
        <iframe 
          id="ad-iframe-${taskId}"
          src="${link}" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen>
        </iframe>
      </div>
      <div class="ad-timer-display" id="timer-display-${taskId}">
        ‚è≥ Stay on page and interact for <span id="timer-${taskId}">15</span> seconds...
      </div>
      <button id="complete-btn-${taskId}" disabled style="
        width:100%;padding:15px;background:#555;color:#fff;border:none;border-radius:10px;
        font-weight:700;font-size:16px;cursor:not-allowed;opacity:0.5;">
        ‚è≥ Please wait...
      </button>
    </div>
  `;
  document.body.appendChild(popup);
  trackAdStart(taskId, task);
  if(currentUser){
    db.ref('liveActivity/' + currentUser.uid).update({
      status: 'viewing_ad',
      location: 'ad_viewer',
      currentTask: {taskId: taskId, taskName: task.name, startTime: Date.now()},
      lastActivity: firebase.database.ServerValue.TIMESTAMP
    });
  }
  let countdown = task.timer || 15;
  let tabSwitchCount = 0;
  let iframeLoaded = false;
  let userInteracted = false;
  let timeCompleted = false;
  const startTime = Date.now();
  const iframe = document.getElementById('ad-iframe-' + taskId);
  const timerSpan = document.getElementById('timer-' + taskId);
  const completeBtn = document.getElementById('complete-btn-' + taskId);
  const closeBtn = popup.querySelector('.ad-close-btn');
  iframe.onload = () => {
    iframeLoaded = true;
    document.getElementById('verify-load-' + taskId).className = 'verification-icon success';
    document.getElementById('verify-load-' + taskId).innerText = '‚úì';
    document.getElementById('verify-load-text-' + taskId).className = 'verification-text success';
    document.getElementById('verify-load-text-' + taskId).innerText = 'Website loaded';
    checkVerification();
  };
  setTimeout(() => {
    if(!iframeLoaded){
      document.getElementById('verify-load-' + taskId).className = 'verification-icon failed';
      document.getElementById('verify-load-' + taskId).innerText = '‚úï';
      document.getElementById('verify-load-text-' + taskId).className = 'verification-text failed';
      document.getElementById('verify-load-text-' + taskId).innerText = 'Failed to load';
      completeBtn.innerText = '‚ùå Website not loaded';
    }
  }, 10000);
  iframe.addEventListener('mouseenter', () => {
    if(!userInteracted){
      userInteracted = true;
      document.getElementById('verify-interact-' + taskId).className = 'verification-icon success';
      document.getElementById('verify-interact-' + taskId).innerText = '‚úì';
      document.getElementById('verify-interact-text-' + taskId).className = 'verification-text success';
      document.getElementById('verify-interact-text-' + taskId).innerText = 'Interaction detected';
      checkVerification();
    }
  });
  window.addEventListener('blur', () => {
    setTimeout(() => {
      if(document.activeElement === iframe && !userInteracted){
        userInteracted = true;
        document.getElementById('verify-interact-' + taskId).className = 'verification-icon success';
        document.getElementById('verify-interact-' + taskId).innerText = '‚úì';
        document.getElementById('verify-interact-text-' + taskId).className = 'verification-text success';
        document.getElementById('verify-interact-text-' + taskId).innerText = 'Interaction detected';
        checkVerification();
      }
    }, 100);
  });
  const visibilityHandler = () => {
    if(document.hidden){
      tabSwitchCount++;
      if(currentUser){
        db.ref('liveActivity/' + currentUser.uid).update({tabSwitches: firebase.database.ServerValue.increment(1)});
      }
      if(tabSwitchCount > 2){
        document.getElementById('timer-display-' + taskId).innerHTML = '<span style="color:var(--red);">‚ö†Ô∏è Warning: Too many tab switches!</span>';
      }
    }
  };
  document.addEventListener('visibilitychange', visibilityHandler);
  const interval = setInterval(() => {
    countdown--;
    timerSpan.innerText = countdown;
    const timeRemaining = document.getElementById('time-remaining-' + taskId);
    if(timeRemaining) timeRemaining.innerText = countdown + 's';
    if(countdown <= 0){
      clearInterval(interval);
      document.removeEventListener('visibilitychange', visibilityHandler);
      timeCompleted = true;
      document.getElementById('verify-time-' + taskId).className = 'verification-icon success';
      document.getElementById('verify-time-' + taskId).innerText = '‚úì';
      document.getElementById('verify-time-text-' + taskId).className = 'verification-text success';
      document.getElementById('verify-time-text-' + taskId).innerText = 'Time completed';
      checkVerification();
    }
  }, 1000);
  function checkVerification(){
    if(iframeLoaded && userInteracted && timeCompleted && tabSwitchCount <= 3){
      const duration = (Date.now() - startTime) / 1000;
      completeBtn.disabled = false;
      completeBtn.style.background = 'linear-gradient(135deg, var(--green) 0%, #27ae60 100%)';
      completeBtn.style.cursor = 'pointer';
      completeBtn.style.opacity = '1';
      completeBtn.innerText = '‚úÖ Claim Your Reward';
      closeBtn.style.display = 'block';
      document.getElementById('timer-display-' + taskId).innerHTML = '<span style="color:var(--green);font-size:16px;">üéâ All requirements completed!</span>';
      document.getElementById('verification-status-' + taskId).style.borderLeftColor = 'var(--green)';
      document.getElementById('verification-status-' + taskId).style.background = 'rgba(46,204,113,0.1)';
      completeBtn.onclick = () => {
        trackAdComplete(taskId, task, duration, tabSwitchCount);
        popup.remove();
        completeTaskWithVerification(taskId, tabSwitchCount);
      };
    }
  }
}
function closeAdPopup(taskId){
  if(confirm('Close? You will not get reward.')){
    const popup = document.getElementById('ad-popup-' + taskId);
    if(popup) popup.remove();
    if(currentUser){
      db.ref('liveActivity/' + currentUser.uid).update({status: 'online', location: 'dashboard', currentTask: null});
    }
  }
}
function trackAdStart(taskId, task){
  if(!currentUser) return;
  db.ref('adTracking/' + currentUser.uid + '/' + taskId).push({
    action: 'start',
    taskName: task.name,
    timestamp: Date.now(),
    date: new Date().toLocaleString()
  });
}
function trackAdComplete(taskId, task, duration, tabSwitches){
  if(!currentUser) return;
  const uid = currentUser.uid;
  const valid = tabSwitches <= 3 && duration >= 15;
  db.ref('adTracking/' + uid + '/' + taskId).push({
    action: 'complete',
    taskName: task.name,
    duration: duration,
    tabSwitches: tabSwitches,
    valid: valid,
    timestamp: Date.now(),
    date: new Date().toLocaleString()
  });
  db.ref('users/' + uid + '/adsViewed').transaction(current => (current || 0) + 1);
  db.ref('liveActivity/' + uid).update({
    status: 'online',
    location: 'dashboard',
    currentTask: null,
    totalAdsViewed: firebase.database.ServerValue.increment(1)
  });
}
function completeTaskWithVerification(taskId, tabSwitches){
  if(!currentUser) return;
  const uid = currentUser.uid;
  if(completedTasks[taskId]){
    alert('‚ö†Ô∏è Already completed!');
    return;
  }
  if(tabSwitches > 3){
    alert('‚ö†Ô∏è Too many tab switches!');
    db.ref('users/' + uid).update({isSuspicious: true});
    return;
  }
  db.ref('tasks/' + taskId).once('value').then(taskSnap => {
    const task = taskSnap.val();
    if(!task) {
      alert('‚ùå Task not found!');
      return;
    }
    const reward = task.reward || 0;
    return db.ref('users/' + uid).once('value').then(userSnap => {
      const userData = userSnap.val();
      const newBalance = (userData.balance || 0) + reward;
      const newTotalEarned = (userData.totalEarned || 0) + reward;
      const updatedCompletedTasks = userData.completedTasks || {};
      updatedCompletedTasks[taskId] = {
        completedAt: Date.now(),
        reward: reward,
        taskName: task.name,
        verified: true,
        adViewed: true,
        tabSwitches: tabSwitches
      };
      return db.ref('users/' + uid).update({
        balance: newBalance,
        totalEarned: newTotalEarned,
        completedTasks: updatedCompletedTasks,
        lastTaskCompletedAt: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        showSuccessAnimation(reward);
        loadTasks();
      });
    });
  }).catch(error => {
    alert('‚ùå Failed!');
  });
}
function showSuccessAnimation(reward){
  const overlay = document.createElement('div');
  overlay.className = 'success-overlay';
  overlay.innerHTML = `
    <div class="success-content">
      <div class="success-icon">üéâ</div>
      <div class="success-title">Congratulations!</div>
      <div class="success-amount">+${reward} Coins</div>
    </div>
  `;
  document.body.appendChild(overlay);
  setTimeout(() => {
    overlay.style.opacity = '0';
    setTimeout(() => overlay.remove(), 300);
  }, 2000);
}
function loadTasks(){
  db.ref('tasks').once('value').then(snapshot => {
    const tasks = snapshot.val();
    const container = document.getElementById('tasks-list');
    container.innerHTML = '';
    if(!tasks){
      container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No tasks</p>';
      return;
    }
    Object.entries(tasks).forEach(([key, t]) => {
      const isCompleted = completedTasks[key];
      const div = document.createElement('div');
      div.className = 'task-box' + (isCompleted ? ' completed' : '');
      div.innerHTML = `
        <div class="task-info">
          <strong>${t.name || 'Task'}</strong>
          <div class="task-reward">üéÅ ${t.reward || 0} coins</div>
        </div>
        <div>
          ${isCompleted ? 
            '<span class="completed-badge">‚úÖ Completed</span>' :
            `<button class="claim-btn" onclick="openTask('${t.link}', '${key}')">Start</button>`
          }
        </div>
      `;
      container.appendChild(div);
    });
  });
}

// =====================================================
// LEADERBOARD
// =====================================================
function loadLeaderboard(){
  const container = document.getElementById('leaderboard-list');
  container.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:50px;animation:spin 2s linear infinite;">‚è≥</div><div>Loading...</div></div>';
  db.ref('users').once('value').then(snapshot => {
    const users = [];
    snapshot.forEach(childSnapshot => {
      const user = childSnapshot.val();
      const uid = childSnapshot.key;
      if(user && user.totalEarned && user.totalEarned > 0){
        users.push({uid: uid, name: user.name || 'User', totalEarned: user.totalEarned || 0});
      }
    });
    users.sort((a, b) => b.totalEarned - a.totalEarned);
    container.innerHTML = '';
    if(users.length === 0){
      container.innerHTML = '<div style="text-align:center;padding:50px;"><div style="font-size:80px;">üèÜ</div><h3>No Rankings</h3></div>';
      return;
    }
    users.forEach((user, index) => {
      const rank = index + 1;
      const isCurrentUser = currentUser && user.uid === currentUser.uid;
      let rankBadgeContent = '#' + rank;
      let rankClass = '';
      let itemClass = '';
      if(rank === 1){
        rankBadgeContent = 'ü•á';
        rankClass = 'gold';
        itemClass = 'top1';
      } else if(rank === 2){
        rankBadgeContent = 'ü•à';
        rankClass = 'silver';
        itemClass = 'top2';
      } else if(rank === 3){
        rankBadgeContent = 'ü•â';
        rankClass = 'bronze';
        itemClass = 'top3';
      }
      if(isCurrentUser) itemClass += ' current-user';
      const div = document.createElement('div');
      div.className = 'leaderboard-item ' + itemClass;
      div.innerHTML = `
        <div class="rank-badge ${rankClass}">${rankBadgeContent}</div>
        <div class="leaderboard-info">
          <div class="leaderboard-name">
            ${user.name}
            ${isCurrentUser ? ' <span style="color:#ffd700;">(You)</span>' : ''}
          </div>
          <div class="leaderboard-earned">
            Total: <span>${user.totalEarned.toLocaleString()} coins</span>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  });
}

// =====================================================
// PROFILE & CHAT
// =====================================================
function loadProfileSettings(){
  if(!userData) return;
  document.getElementById('profile-name').innerText = userData.name || 'N/A';
  document.getElementById('profile-phone').innerText = userData.phone || 'N/A';
  document.getElementById('profile-email').innerText = userData.email || 'N/A';
  document.getElementById('profile-uid').innerText = userData.userID || 'N/A';
  document.getElementById('profile-joined').innerText = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString() : 'N/A';
  document.getElementById('profile-balance').innerText = (userData.balance || 0) + ' coins';
  document.getElementById('profile-earned').innerText = (userData.totalEarned || 0) + ' coins';
  document.getElementById('profile-withdrawn').innerText = (userData.totalWithdrawn || 0) + ' coins';
  document.getElementById('profile-ads-viewed').innerText = userData.adsViewed || 0;
}
function loadChat(){
  if(!currentUser) return;
  const uid = currentUser.uid;
  const messagesContainer = document.getElementById('chat-messages');
  db.ref('chats/' + uid).on('value', snapshot => {
    messagesContainer.innerHTML = '';
    if(!snapshot.exists()){
      messagesContainer.innerHTML = '<div style="text-align:center;padding:40px;"><div style="font-size:48px;">üí¨</div><div>No messages</div></div>';
      return;
    }
    snapshot.forEach(childSnapshot => {
      const msg = childSnapshot.val();
      const div = document.createElement('div');
      div.className = 'chat-message ' + msg.sender;
      div.innerHTML = `
        <div class="message-bubble">${msg.message}</div>
        <div class="message-time">${msg.time || ''}</div>
      `;
      messagesContainer.appendChild(div);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });
}
function sendMessage(){
  if(!currentUser) return;
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  if(!message) return;
  db.ref('chats/' + currentUser.uid).push({
    sender: 'user',
    message: message,
    timestamp: Date.now(),
    time: new Date().toLocaleTimeString(),
    userName: userData.name || 'User',
    userID: userData.userID || 'N/A'
  }).then(() => {
    input.value = '';
  });
}

// =====================================================
// AUTH
// =====================================================
function toggleAuthMode(){
  isSignupMode = !isSignupMode;
  const signupFields = document.getElementById('signup-fields');
  const authTitle = document.getElementById('auth-title');
  const authBtn = document.getElementById('auth-btn');
  const toggleText = document.getElementById('toggle-auth');
  if(isSignupMode){
    signupFields.style.display = 'block';
    authTitle.innerText = 'Sign Up';
    authBtn.innerText = 'Create Account';
    toggleText.innerText = 'Already have an account? Login';
  } else {
    signupFields.style.display = 'none';
    authTitle.innerText = 'Take Master';
    authBtn.innerText = 'Login';
    toggleText.innerText = "Don't have an account? Sign Up";
  }
  clearError('auth-error');
}
function handleAuth(){
  if(isSignupMode) signup();
  else login();
}
async function signup(){
  const name = document.getElementById('signup-name').value.trim();
  const phone = document.getElementById('signup-phone').value.trim();
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const referCode = document.getElementById('signup-refer').value.trim();
  clearError('auth-error');
  if(!name || !phone || !email || !password){ 
    showError('auth-error', 'Fill all required fields');
    return; 
  }
  if(password.length < 6){
    showError('auth-error', 'Password min 6 chars');
    return;
  }
  if(!/^01[0-9]{9}$/.test(phone)){
    showError('auth-error', 'Valid phone (11 digits)');
    return;
  }
  try {
    showError('auth-error', '‚è≥ Creating account...');
    if(!deviceFingerprint || !userIP) await initializeDeviceDetection();
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = cred.user;
    await db.ref('users/'+currentUser.uid).set({
      name: name,
      phone: phone,
      email: email,
      uid: currentUser.uid,
      userID: 'TM' + Date.now().toString().slice(-6) + Math.floor(Math.random() * 1000).toString().padStart(3, '0'),
      balance: 0,
      totalEarned: 0,
      totalWithdrawn: 0,
      pendingWithdraw: 0,
      completedTasks: {},
      adsViewed: 0,
      totalReferrals: 0,
      referralEarnings: 0,
      dailyStreak: 0,
      lastDailyBonus: 0,
      createdAt: Date.now(),
      deviceInfo: {ip: userIP, deviceId: deviceFingerprint, userAgent: navigator.userAgent, platform: navigator.platform},
      isBlocked: false,
      isSuspicious: false
    });
    if(referCode){
      await processReferral(referCode, currentUser.uid);
    }
    clearError('auth-error');
  } catch(err) {
    if(err.code === 'auth/email-already-in-use'){
      showError('auth-error', '‚ùå Email exists. Login instead.');
    } else {
      showError('auth-error', '‚ùå ' + err.message);
    }
  }
}
function login(){
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  clearError('auth-error');
  if(!email || !password){
    showError('auth-error', 'Enter email and password');
    return;
  }
  showError('auth-error', '‚è≥ Logging in...');
  auth.signInWithEmailAndPassword(email, password)
    .then(cred => {
      currentUser = cred.user;
      clearError('auth-error');
    })
    .catch(err => {
      showError('auth-error', '‚ùå Invalid credentials');
    });
}
function logout(){
  if(confirm('Logout?')){
    auth.signOut().then(()=>{
      currentUser = null;
      userBalance = 0;
    });
  }
}

// =====================================================
// WITHDRAW
// =====================================================
function selectMethod(method){
  selectedWithdrawMethod = method;
  document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('withdraw-method').value = method;
}
function submitWithdraw(){
  const method = document.getElementById('withdraw-method').value.trim();
  const account = document.getElementById('withdraw-account').value.trim();
  const bdtInput = document.getElementById('withdraw-amount').value;
  clearError('withdraw-error');
  clearError('withdraw-success');
  if(!currentUser || !method || !account){
    showError('withdraw-error', '‚ö†Ô∏è Fill all fields');
    return;
  }
  const bdtAmount = parseInt(bdtInput);
  if(!bdtInput || isNaN(bdtAmount) || bdtAmount < minWithdrawBDT){
    showError('withdraw-error', `‚ö†Ô∏è Min ${minWithdrawBDT} ‡ß≥ withdraw`);
    return;
  }
  const requiredCoins = bdtToCoins(bdtAmount);
  if(requiredCoins > userBalance){
    const availableBDT = coinsToBDT(userBalance);
    showError('withdraw-error', `‚ö†Ô∏è Insufficient balance. You have ${userBalance} coins (${availableBDT} ‡ß≥)`);
    return;
  }
  if(!confirm(`Withdraw ${bdtAmount} ‡ß≥ (${requiredCoins} coins)?`)) return;
  const submitBtn = document.getElementById('withdraw-submit-btn');
  submitBtn.disabled = true;
  submitBtn.innerText = '‚è≥ Processing...';
  const uid = currentUser.uid;
  const withdrawData = {
    uid: uid,
    userID: userData.userID || 'N/A',
    userName: userData.name || 'Unknown',
    userPhone: userData.phone || 'N/A',
    userEmail: userData.email || currentUser.email || 'N/A',
    method: method,
    account: account,
    coinAmount: requiredCoins,
    bdtAmount: bdtAmount,
    conversionRate: conversionRate,
    status: 'pending',
    requestedAt: Date.now(),
    date: new Date().toLocaleString(),
    source: 'main_wallet'
  };
  const newBalance = userBalance - requiredCoins;
  const newPending = (userData.pendingWithdraw || 0) + requiredCoins;
  db.ref('users/' + uid).update({balance: newBalance, pendingWithdraw: newPending})
  .then(() => db.ref('withdraw_requests').push(withdrawData))
  .then(() => {
    showSuccess('withdraw-success', `‚úÖ Withdraw request submitted! You will receive ${bdtAmount} ‡ß≥`);
    document.getElementById('withdraw-account').value = '';
    document.getElementById('withdraw-amount').value = '';
    document.getElementById('coin-conversion-display').style.display = 'none';
    submitBtn.disabled = false;
    submitBtn.innerText = 'üí∏ Request Withdraw';
    setTimeout(() => {
      clearError('withdraw-success');
      showSection('dashboard');
    }, 3000);
  })
  .catch(error => {
    showError('withdraw-error', '‚ùå Failed');
    db.ref('users/' + uid).update({balance: userBalance, pendingWithdraw: userData.pendingWithdraw || 0});
    submitBtn.disabled = false;
    submitBtn.innerText = 'üí∏ Request Withdraw';
  });
}

// =====================================================
// GAME WALLET FUNCTIONS
// =====================================================
function showGameWalletTransfer(direction){
  showSection('wallet-section');
  if(direction === 'toMain'){
    selectTransferOption('gameToMain');
  } else {
    selectTransferOption('mainToGame');
  }
}

function showGameWalletWithdraw(){
  const method = document.getElementById('withdraw-method').value.trim();
  const account = document.getElementById('withdraw-account').value.trim();
  clearError('withdraw-error');
  clearError('withdraw-success');
  
  if(slotWalletBalance <= 0){
    showError('withdraw-error', '‚ö†Ô∏è No coins in game wallet');
    return;
  }
  
  if(!currentUser || !method || !account){
    showError('withdraw-error', '‚ö†Ô∏è Fill all fields for game wallet withdraw');
    return;
  }
  
  if(!confirm(`Withdraw ${slotWalletBalance} coins (${coinsToBDT(slotWalletBalance)} ‡ß≥) from game wallet?`)) return;
  
  const submitBtn = document.getElementById('withdraw-submit-btn');
  submitBtn.disabled = true;
  submitBtn.innerText = '‚è≥ Processing...';
  
  const uid = currentUser.uid;
  const bdtAmount = coinsToBDT(slotWalletBalance);
  const withdrawData = {
    uid: uid,
    userID: userData.userID || 'N/A',
    userName: userData.name || 'Unknown',
    userPhone: userData.phone || 'N/A',
    userEmail: userData.email || currentUser.email || 'N/A',
    method: method,
    account: account,
    coinAmount: slotWalletBalance,
    bdtAmount: bdtAmount,
    conversionRate: conversionRate,
    status: 'pending',
    requestedAt: Date.now(),
    date: new Date().toLocaleString(),
    source: 'game_wallet'
  };
  
  // Update game wallet balance and user pending withdraw
  db.ref(`gameWallets/${uid}/balance`).set(0);
  db.ref(`users/${uid}/pendingWithdraw`).transaction(current => (current || 0) + slotWalletBalance)
    .then(() => db.ref('withdraw_requests').push(withdrawData))
    .then(() => {
      showSuccess('withdraw-success', `‚úÖ Game wallet withdraw request submitted! You will receive ${bdtAmount} ‡ß≥`);
      submitBtn.disabled = false;
      submitBtn.innerText = 'üí∏ Request Withdraw';
      setTimeout(() => {
        clearError('withdraw-success');
        showSection('dashboard');
      }, 3000);
    })
    .catch(error => {
      showError('withdraw-error', '‚ùå Failed to process game wallet withdraw');
      submitBtn.disabled = false;
      submitBtn.innerText = 'üí∏ Request Withdraw';
    });
}

function selectTransferOption(option){
  currentTransferOption = option;
  
  // Update UI
  document.querySelectorAll('.transfer-option').forEach(opt => opt.classList.remove('active'));
  if(option === 'mainToGame'){
    document.getElementById('transfer-main-to-game').classList.add('active');
    document.getElementById('transfer-details').innerText = `Max: ${userBalance} coins from Main Wallet`;
  } else {
    document.getElementById('transfer-game-to-main').classList.add('active');
    document.getElementById('transfer-details').innerText = `Max: ${slotWalletBalance} coins from Game Wallet`;
  }
}

function executeTransfer(){
  const amount = parseInt(document.getElementById('transfer-amount').value);
  clearError('transfer-error');
  clearError('transfer-success');
  
  if(isNaN(amount) || amount <= 0){
    showError('transfer-error', 'Enter a valid amount');
    return;
  }
  
  if(currentTransferOption === 'mainToGame'){
    if(amount > userBalance){
      showError('transfer-error', 'Insufficient main balance');
      return;
    }
    
    const updates = {};
    updates[`gameWallets/${currentUser.uid}/balance`] = (slotWalletBalance || 0) + amount;
    updates[`users/${currentUser.uid}/balance`] = userBalance - amount;
    
    db.ref().update(updates).then(()=>{
      showSuccess('transfer-success', `‚úÖ Transferred ${amount} coins to Game Wallet`);
      document.getElementById('transfer-amount').value = '';
      addGameWalletTransaction('transfer_in', amount, 'Main Wallet');
    }).catch(()=>{
      showError('transfer-error', '‚ùå Transfer failed');
    });
    
  } else {
    if(amount > (slotWalletBalance || 0)){
      showError('transfer-error', 'Insufficient game wallet balance');
      return;
    }
    
    const updates = {};
    updates[`gameWallets/${currentUser.uid}/balance`] = (slotWalletBalance || 0) - amount;
    updates[`users/${currentUser.uid}/balance`] = userBalance + amount;
    
    db.ref().update(updates).then(()=>{
      showSuccess('transfer-success', `‚úÖ Transferred ${amount} coins to Main Wallet`);
      document.getElementById('transfer-amount').value = '';
      addGameWalletTransaction('transfer_out', amount, 'Main Wallet');
    }).catch(()=>{
      showError('transfer-error', '‚ùå Transfer failed');
    });
  }
}

function addGameWalletTransaction(type, amount, description){
  if(!currentUser) return;
  
  const transaction = {
    type: type,
    amount: amount,
    description: description,
    timestamp: Date.now(),
    date: new Date().toLocaleString()
  };
  
  db.ref(`gameWalletTransactions/${currentUser.uid}`).push(transaction);
}

// =====================================================
// WALLET & NOTIFICATIONS
// =====================================================
function loadWalletPage(){
  document.getElementById('wallet-current-balance').innerText = userBalance;
  document.getElementById('wallet-total-earned').innerText = userData.totalEarned || 0;
  document.getElementById('wallet-withdrawn').innerText = userData.totalWithdrawn || 0;
  document.getElementById('wallet-pending').innerText = userData.pendingWithdraw || 0;
  document.getElementById('wallet-game-balance').innerText = slotWalletBalance || 0;
  
  // Update transfer amounts
  document.getElementById('main-to-game-amount').innerText = userBalance;
  document.getElementById('game-to-main-amount').innerText = slotWalletBalance || 0;
}
function loadNotifications(){
  if(!currentUser) return;
  db.ref('notifications/' + currentUser.uid).on('value', snapshot => {
    const container = document.getElementById('notifications-list');
    container.innerHTML = '';
    let unreadCount = 0;
    const notifications = [];
    snapshot.forEach(childSnapshot => {
      const notif = childSnapshot.val();
      notif.key = childSnapshot.key;
      notifications.push(notif);
      if(!notif.read) unreadCount++;
    });
    const countElem = document.getElementById('notification-count');
    if(unreadCount > 0){
      countElem.innerText = unreadCount;
      countElem.style.display = 'block';
    } else {
      countElem.style.display = 'none';
    }
    if(notifications.length === 0){
      container.innerHTML = '<div style="text-align:center;padding:20px;">No notifications</div>';
      return;
    }
    notifications.sort((a, b) => b.timestamp - a.timestamp);
    notifications.forEach(notif => {
      const div = document.createElement('div');
      div.className = 'notification-item' + (!notif.read ? ' unread' : '');
      div.innerHTML = `
        <div class="notification-header">
          <div class="notification-title">
            ${notif.title}
            ${!notif.read ? '<span class="notification-badge">NEW</span>' : ''}
          </div>
          <div class="notification-date">${notif.date || ''}</div>
        </div>
        <div class="notification-message">${notif.message}</div>
      `;
      container.appendChild(div);
    });
  });
}
function loadUserProfile(){
  if(!currentUser) return;
  db.ref('users/'+currentUser.uid).on('value', snapshot=>{
    const data = snapshot.val();
    if(!data) return;
    userData = data;
    userBalance = data.balance || 0;
    completedTasks = data.completedTasks || {};
    document.getElementById('user-name').innerText = data.name;
    document.getElementById('user-phone').innerText = 'üì± ' + data.phone;
    document.getElementById('user-uid').innerText = 'üÜî ' + data.userID;
    document.getElementById('user-balance').innerText = userBalance;
    updateWithdrawDisplay();
  });
}
function loadNotice(){
  db.ref('notice_board/text').on('value', snap=>{
    document.getElementById('notice-text').innerText = snap.val() || 'Welcome!';
  });
}

// =====================================================
// SLOT MACHINE JS - ENHANCED WITH ADMIN WIN CONTROL & FASTER SPINNING
// =====================================================
function loadSlotSettings(){
  db.ref('settings/slot').on('value', snap => {
    const v = snap.val();
    if(v){
      slotSettings = {
        enabledDays: Array.isArray(v.enabledDays) ? v.enabledDays : [5],
        spinCost: v.spinCost ?? 10,
        minDeposit: v.minDeposit ?? 50,
        virtualNumbers: v.virtualNumbers || slotSettings.virtualNumbers
      };
    }
    initSlotRound();
    loadUserWinRate();
    refreshSlotUI();
  });
}
function loadUserWinRate(){
  if(!currentUser) return;
  // Load admin-controlled win rate for this user
  db.ref(`slotWinRates/${currentUser.uid}`).on('value', snap => {
    const rate = snap.val();
    if(rate && typeof rate.rate === 'number'){
      userWinRate = rate.rate; // 0-100 percentage
    } else {
      userWinRate = 15; // default 15%
    }
    console.log(`User win rate: ${userWinRate}%`);
  });
}
function initSlotRound(){
  const now = new Date();
  const day = now.getDay();
  const dateStr = now.toISOString().slice(0,10);
  const enabledToday = slotSettings.enabledDays.includes(day);
  let startAt = null, endAt = null, id = null;

  if(enabledToday){
    startAt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0).getTime();
    endAt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999).getTime();
    id = `SRV-${dateStr}`;
  } else {
    // find next enabled day
    let next = (day + 1) % 7, count = 1;
    while(!slotSettings.enabledDays.includes(next) && count <= 7){ next = (next+1)%7; count++; }
    const nextDate = new Date(now);
    nextDate.setDate(now.getDate() + count);
    startAt = new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate(), 0,0,0,0).getTime();
    endAt = new Date(nextDate.getFullYear(), nextDate.getMonth(), nextDate.getDate(), 23,59,59,999).getTime();
    id = `SRV-${nextDate.toISOString().slice(0,10)}`;
  }

  currentSlotRound = { id, dateStr: id.split('-')[1], day: enabledToday ? day : new Date(startAt).getDay(), startAt, endAt };
  db.ref(`slotRounds/${id}`).update({ id, dateStr: id.split('-')[1], day: currentSlotRound.day, startAt, endAt });
}
function refreshSlotUI(){
  if(!currentSlotRound) return;
  const now = Date.now();
  const allowed = now >= currentSlotRound.startAt && now <= currentSlotRound.endAt;

  const statusBadge = document.getElementById('slot-status-badge');
  const spinBtn = document.getElementById('spin-btn');
  statusBadge.className = 'slot-badge ' + (allowed ? 'ok' : 'no');
  statusBadge.innerText = allowed ? 'Open Now' : 'Closed';

  document.getElementById('slot-spin-cost').innerText = slotSettings.spinCost;
  document.getElementById('slot-round-id').innerText = currentSlotRound.id;
  document.getElementById('slot-next-round').innerText = new Date(currentSlotRound.endAt).toLocaleDateString();

  spinBtn.disabled = !allowed || isSpinning;
  spinBtn.innerText = allowed ? 'üéØ Spin Now' : 'üîí Not Available';

  document.getElementById('slot-msg').innerText = allowed ? 'Spin and test your luck!' : 'Slot game is available only on Friday.';

  // Load Game Wallet balance
  loadGameWallet();
  // Load history
  loadSpinHistory();
}
function loadGameWallet(){
  if(!currentUser) return;
  db.ref(`gameWallets/${currentUser.uid}/balance`).on('value', snap=>{
    slotWalletBalance = snap.val() || 0;
    document.getElementById('slot-wallet-balance').innerText = slotWalletBalance;
    document.getElementById('game-wallet-display').innerText = `${slotWalletBalance} coins in game wallet.`;
    document.getElementById('game-wallet-balance').innerText = `${slotWalletBalance} coins`;
    // Update Wallet page
    document.getElementById('wallet-game-balance').innerText = slotWalletBalance;
    document.getElementById('game-to-main-amount').innerText = slotWalletBalance;
  });
}

// NEW: Deposit from main balance to game wallet
function depositToGameWallet(){
  if(!currentUser) {
    alert('Please login first');
    return;
  }
  
  const amount = parseInt(document.getElementById('deposit-amount').value);
  if(!amount || amount < 1){
    alert('Please enter a valid amount');
    return;
  }
  
  if(amount > userBalance){
    alert('Insufficient main balance');
    return;
  }
  
  // Confirm deposit
  if(!confirm(`Transfer ${amount} coins from main balance to game wallet?`)){
    return;
  }
  
  // Update both balances atomically
  const updates = {};
  updates[`gameWallets/${currentUser.uid}/balance`] = (slotWalletBalance || 0) + amount;
  updates[`users/${currentUser.uid}/balance`] = userBalance - amount;
  
  db.ref().update(updates).then(() => {
    alert(`‚úÖ Successfully deposited ${amount} coins to game wallet!`);
    document.getElementById('deposit-amount').value = '';
    addGameWalletTransaction('deposit', amount, 'Main Wallet');
  }).catch(error => {
    console.error('Deposit failed:', error);
    alert('‚ùå Deposit failed. Please try again.');
  });
}

function startSpin(){
  if(isSpinning) return;
  
  if(!currentUser || !currentSlotRound) {
    alert('System not ready');
    return;
  }
  const now = Date.now();
  if(!(now >= currentSlotRound.startAt && now <= currentSlotRound.endAt)){
    alert('Not available now.');
    return;
  }
  if(slotWalletBalance < slotSettings.spinCost){
    alert('Insufficient game wallet balance. Please deposit from main balance.');
    return;
  }

  isSpinning = true;
  document.getElementById('spin-btn').disabled = true;
  document.getElementById('spin-btn').innerText = '‚è≥ Spinning...';
  document.getElementById('slot-msg').innerText = 'Spinning the reels...';

  const reels = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];
  reels.forEach(r => { r.classList.add('spinning'); r.textContent = 'üåÄ'; });

  // Deduct cost immediately
  db.ref(`gameWallets/${currentUser.uid}/balance`).transaction(cur => (cur||0) - slotSettings.spinCost);

  // Create spin record
  const spinId = `spin-${currentSlotRound.id}-${currentUser.uid}-${Date.now()}`;
  const spinData = {
    id: spinId,
    roundId: currentSlotRound.id,
    uid: currentUser.uid,
    userName: userData?.name || 'User',
    status: 'spinning',
    timestamp: Date.now(),
    cost: slotSettings.spinCost,
    winRate: userWinRate // Track the win rate used
  };

  db.ref(`slotSpins/${currentSlotRound.id}/${spinId}`).set(spinData).then(() => {
    // Faster spinning time - 2 seconds instead of 3
    setTimeout(() => {
      // Generate result with admin-controlled win rate
      const result = generateSpinResultWithWinRate(userWinRate);
      const isWin = checkWin(result);
      const payout = isWin ? slotSettings.spinCost * 5 : 0; // 5x payout for win
      
      // Update spin record
      db.ref(`slotSpins/${currentSlotRound.id}/${spinId}`).update({
        status: 'done',
        result: result,
        win: isWin,
        payout: payout
      });

      // Show result with faster animation
      showSpinResult(result, isWin, payout);
      
      // Credit if win
      if(isWin && payout > 0){
        db.ref(`gameWallets/${currentUser.uid}/balance`).transaction(cur => (cur||0) + payout);
        addGameWalletTransaction('win', payout, 'Slot Machine');
      }

      isSpinning = false;
      refreshSlotUI();
    }, 2000); // 2 second spin animation
  });
}
function generateSpinResultWithWinRate(winRate){
  // winRate is percentage (0-100)
  const winChance = winRate / 100;
  const random = Math.random();
  
  if(random < winChance) {
    // Win - all same symbol
    const symbol = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
    return [symbol, symbol, symbol];
  } else {
    // Lose - random different symbols
    const symbol1 = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
    let symbol2, symbol3;
    do {
      symbol2 = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
    } while(symbol2 === symbol1);
    do {
      symbol3 = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
    } while(symbol3 === symbol1 || symbol3 === symbol2);
    return [symbol1, symbol2, symbol3];
  }
}
function checkWin(result){
  return result[0] === result[1] && result[1] === result[2];
}
function showSpinResult(result, isWin, payout){
  const reels = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];
  
  // Faster result display - staggered timing
  setTimeout(() => {
    reels[0].classList.remove('spinning'); 
    reels[0].textContent = result[0];
    reels[0].style.transform = 'scale(1.1)';
  }, 200);
  
  setTimeout(() => {
    reels[1].classList.remove('spinning'); 
    reels[1].textContent = result[1];
    reels[1].style.transform = 'scale(1.1)';
  }, 400);
  
  setTimeout(() => {
    reels[2].classList.remove('spinning'); 
    reels[2].textContent = result[2];
    reels[2].style.transform = 'scale(1.1)';
    // Reset scale after animation
    setTimeout(() => {
      reels.forEach(r => r.style.transform = 'scale(1)');
    }, 300);
  }, 600);

  document.getElementById('slot-last-result').innerText = `${result[0]} ${result[1]} ${result[2]}  ${isWin ? '-> WIN' : '-> LOSE'}`;
  
  if(isWin){
    document.getElementById('slot-msg').innerText = `üéâ You won ${payout} coins!`;
    showSuccessAnimation(payout);
  } else {
    document.getElementById('slot-msg').innerText = 'Try again!';
  }
  
  loadSpinHistory();
}
function loadSpinHistory(){
  if(!currentUser || !currentSlotRound) return;
  const list = document.getElementById('slot-history-list');
  db.ref(`slotSpins/${currentSlotRound.id}`).orderByChild('timestamp').limitToLast(10)
    .once('value').then(snap=>{
      const items = [];
      snap.forEach(child=>{
        const s = child.val();
        if(s.uid === currentUser.uid) items.push(s);
      });
      items.sort((a,b)=>b.timestamp-a.timestamp);
      if(items.length === 0){
        list.innerHTML = 'No spins yet';
        return;
      }
      list.innerHTML = '';
      items.forEach(s=>{
        const isWin = !!s.win;
        const [a,b,c] = s.result || ['-','-','-'];
        const el = document.createElement('div');
        el.className = 'hist-item';
        el.innerHTML = `
          <div class="hist-left">
            <div class="hist-badge">${isWin ? 'üèÜ' : 'üé≤'}</div>
            <div>
              <div><strong>${a} ${b} ${c}</strong></div>
              <div class="hist-time">${new Date(s.timestamp).toLocaleString()}</div>
            </div>
          </div>
          <div class="${isWin ? 'hist-win' : 'hist-lose'}">
            ${isWin ? `+${s.payout} coins` : `-${s.cost} coins`}
          </div>
        `;
        list.appendChild(el);
      });
    });
}

// =====================================================
// LIVE TRADING
// =====================================================
function initTradingChart(){
  const ctx = document.getElementById('priceChart').getContext('2d');
  tradingChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Coins per ‡ß≥',
        data: [],
        borderColor: '#ffd700',
        backgroundColor: 'rgba(255,215,0,0.15)',
        fill: true,
        tension: 0.25,
        pointRadius: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { ticks: { color: '#bbb', maxTicksLimit: 5 } },
        y: { ticks: { color: '#bbb' }, grid: { color: 'rgba(255,255,255,0.05)'} }
      }
    }
  });
}
function startPriceListener(){
  db.ref('settings/liveTrading/price').on('value', snap => {
    const price = snap.val();
    if(typeof price === 'number' && isFinite(price)){
      const now = Date.now();
      priceHistory.push({t: now, v: price});
      if(priceHistory.length > 60) priceHistory.shift();
      renderPrice();
    }
  });
}
function renderPrice(){
  const last = priceHistory[priceHistory.length - 1];
  const first = priceHistory[0];
  const priceElem = document.getElementById('trading-price');
  const changeElem = document.getElementById('trading-change');
  if(last){
    priceElem.textContent = last.v.toFixed(2);
    if(first && first !== last){
      const diff = last.v - first.v;
      changeElem.textContent = (diff >= 0 ? '‚ñ≤ +' : '‚ñº ') + diff.toFixed(2);
      changeElem.classList.toggle('up', diff >= 0);
      changeElem.classList.toggle('down', diff < 0);
    } else {
      changeElem.textContent = '-';
    }
  }
  if(tradingChart){
    tradingChart.data.labels = priceHistory.map(p => new Date(p.t).toLocaleTimeString());
    tradingChart.data.datasets[0].data = priceHistory.map(p => p.v);
    tradingChart.update();
  }
}

// =====================================================
// MISC
// =====================================================
function showError(id, msg){
  const elem = document.getElementById(id);
  if(elem){
    elem.innerText = msg;
    elem.style.display = 'block';
  }
}
function clearError(id){
  const elem = document.getElementById(id);
  if(elem){
    elem.innerText = '';
    elem.style.display = 'none';
  }
}
function showSuccess(id, msg){
  const elem = document.getElementById(id);
  if(elem){
    elem.innerText = msg;
    elem.style.display = 'block';
  }
}
function showSection(section){
  document.getElementById('dashboard-content').style.display = 'none';
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.querySelectorAll('.menu-list li').forEach(li => li.classList.remove('active'));
  if(section === 'dashboard'){
    document.getElementById('dashboard-content').style.display = 'block';
  } else {
    document.getElementById(section).style.display = 'block';
    if(section === 'wallet-section') loadWalletPage();
    else if(section === 'leaderboard-section') loadLeaderboard();
    else if(section === 'profile-section') loadProfileSettings();
    else if(section === 'chat-section') loadChat();
    else if(section === 'refer-section') loadReferralList();
    else if(section === 'trading-section') {
      if(!tradingChart) initTradingChart();
      startPriceListener();
      renderPrice(); // ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶§‡ßá
    }
  }
  closeMenu();
}
function openMenu(){
  document.getElementById('side-menu').classList.add('open');
  document.querySelector('.menu-bg').style.display='block';
}
function closeMenu(){
  document.getElementById('side-menu').classList.remove('open');
  document.querySelector('.menu-bg').style.display='none';
}

// =====================================================
// INIT
// =====================================================
auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    document.getElementById('auth-section').style.display='none';
    document.getElementById('dashboard').style.display='block';
    loadUserProfile();
    loadTasks();
    loadNotice();
    loadNotifications();
    loadDailyBonusSettings();
    loadReferSettings();
    loadMyReferCode();
    loadReferStats();
    loadConversionRate();
    startLiveActivityTracking();
    loadTelegramChannel();
    
    // Load Slot Machine
    loadSlotSettings();
  } else {
    currentUser = null;
    document.getElementById('auth-section').style.display='block';
    document.getElementById('dashboard').style.display='none';
  }
});

const urlParams = new URLSearchParams(window.location.search);
const refCode = urlParams.get('ref');
if(refCode){
  document.getElementById('signup-refer').value = refCode.toUpperCase();
  if(!isSignupMode){
    toggleAuthMode();
  }
}

initializeDeviceDetection();
console.log('‚úÖ Take Master Loaded - Game Wallet Withdraw System Added');
</script>
</body>
</html>